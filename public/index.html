<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wealth Management Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="js/api.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // 检查用户登录状态
    function checkLoginStatus() {
      // 从localStorage获取登录状态
      const isLoggedIn = localStorage.getItem('isLoggedIn');
      const userToken = localStorage.getItem('userToken');
      
      // 如果没有登录状态或token，跳转到登录页面
      if (!isLoggedIn || !userToken) {
        window.location.href = 'log_in.html';
        return false;
      }
      
      // 如果已登录，更新用户区域显示
      updateUserArea();
      return true;
    }

    // 更新用户区域显示
    function updateUserArea() {
      const userAccount = localStorage.getItem('userAccount');
      const userArea = document.getElementById('userArea');
      
      if (userAccount) {
        userArea.innerHTML = `
          <div class="flex items-center space-x-3">
            <span class="text-gray-700 font-medium">${userAccount}</span>
            <button onclick="logout()" 
              class="text-red-500 hover:text-red-600 text-sm font-medium bg-transparent px-3 py-1 rounded border border-red-300 hover:border-red-400 transition">
              Logout
            </button>
          </div>
        `;
      } else {
        // 如果没有登录信息，显示登录链接
        userArea.innerHTML = `
          <a href="log_in.html" class="text-blue-500 hover:text-blue-600 text-lg font-bold bg-transparent px-4 py-2 rounded transition">
            Login
          </a>
        `;
      }
    }

    // 登出功能
    function logout() {
      localStorage.removeItem('isLoggedIn');
      localStorage.removeItem('userToken');
      localStorage.removeItem('userAccount');
      localStorage.removeItem('currentUserId'); // 同时清除用户ID
      window.location.href = 'log_in.html';
    }

    // 页面加载时检查登录状态 - 已移至下方统一处理
  </script>
  <style>
    @keyframes marquee {
      0% {
        transform: translateX(100%);
      }

      100% {
        transform: translateX(-100%);
      }
    }

    .animate-marquee {
      display: inline-block;
      white-space: nowrap;
      animation: marquee 20s linear infinite;
    }

    /* 新增样式 */
    .asset-card {
      background-color: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: all 0.3s ease;
    }

    .asset-card:hover {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      transform: translateY(-3px);
    }

    /* 价格更新动画 */
    @keyframes priceFlash {
      0% { background-color: rgba(59, 130, 246, 0.3); }
      50% { background-color: rgba(59, 130, 246, 0.6); }
      100% { background-color: transparent; }
    }

    .price-updated {
      animation: priceFlash 1s ease-in-out;
      border-radius: 4px;
      padding: 2px 4px;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 text-gray-800 min-h-screen">
  <!-- 顶部导航 -->
  <header class="bg-white shadow h-16 px-6 flex justify-between items-center sticky top-0 z-50">
    <!-- Left: Logo and platform name -->
    <a href="index.html" class="flex items-center space-x-4 group cursor-pointer select-none">
      <!-- Logo icon -->
      <svg class="w-9 h-9 text-blue-400 group-hover:text-blue-600 transition" fill="none" stroke="currentColor"
        stroke-width="2" viewBox="0 0 32 32">
        <circle cx="16" cy="16" r="13" stroke="currentColor" stroke-width="2" fill="#e0f2fe" />
        <path d="M10 20c2-4 10-4 12 0" stroke="#38bdf8" stroke-width="2" fill="none" />
        <path d="M16 10v8" stroke="#2563eb" stroke-width="2" stroke-linecap="round" />
        <circle cx="16" cy="10" r="2" fill="#2563eb" />
      </svg>
      <span class="text-2xl font-extrabold text-blue-400 group-hover:text-blue-600 tracking-wide transition leading-none"
        style="letter-spacing: 1px;">
        Future Assets
      </span>
    </a>
    <!-- Right: User area -->
    <div class="flex items-center space-x-4">
      <div id="userArea">
        <!-- 这里会被JavaScript动态更新 -->
      </div>
    </div>
  </header>


  <!-- 页面布局 -->
  <div class="flex">
    <!-- 左侧导航栏 -->
    <aside id="sidebar" class="w-48 bg-white shadow min-h-screen p-3 flex flex-col items-center transition-all duration-300 hidden md:flex fixed top-16 left-0 z-40">
      <button id="sidebarToggle" class="mb-6 p-2 rounded hover:bg-blue-100 transition self-end" onclick="toggleSidebar()">
        <svg id="sidebarToggleIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 12H5" /></svg>
      </button>
      <nav class="space-y-4 flex flex-col items-center w-full mt-20">
        <a href="index.html"
          class="flex flex-col items-center justify-center px-2 py-2 rounded hover:bg-blue-50 transition text-blue-500 font-semibold sidebar-link" data-i18n="dashboard">
            <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8v-10h-8v10zm0-18v6h8V3h-8z"/></svg>
            <span class="sidebar-text mt-1 text-center">Dashboard</span>
        </a>
        <a href="detail.html"
          class="flex flex-col items-center justify-center px-2 py-2 rounded hover:bg-blue-50 transition text-gray-700 hover:text-blue-500 sidebar-link" data-i18n="allocation">
            <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 2v10l6 6"/></svg>
            <span class="sidebar-text mt-1 text-center">Position Details</span>
        </a>
        <a href="management.html"
          class="flex flex-col items-center justify-center px-2 py-2 rounded hover:bg-blue-50 transition text-gray-700 hover:text-blue-500 sidebar-link" data-i18n="positions">
            <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2"/><path d="M16 3v4M8 3v4"/></svg>
            <span class="sidebar-text mt-1 text-center">Position Management</span>
        </a>
      </nav>
    </aside>

    <!-- 右侧内容区域 -->
    <main id="mainContent" class="flex-1 p-6 pt-6 md:ml-48 transition-all duration-300">
      <!-- 居中搜索框 -->
      <div class="w-full flex mb-6">
        <div class="mx-auto w-96 relative">
          <input id="stockSearchInput" type="text" placeholder="Search stock code or name..." class="w-full px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-200 text-base" autocomplete="off" />
          <button id="stockSearchBtn" class="absolute right-0 top-0 h-full px-5 bg-blue-500 text-white rounded-r-lg hover:bg-blue-600 transition">Search</button>
          <ul id="stockSearchSuggest" class="absolute left-0 top-full w-full bg-white border border-gray-200 rounded-b-lg shadow z-10 hidden max-h-60 overflow-y-auto"></ul>
        </div>
      </div>
      <script>
        const input = document.getElementById('stockSearchInput');
        const btn = document.getElementById('stockSearchBtn');
        const suggest = document.getElementById('stockSearchSuggest');
        let timer = null;
        input.addEventListener('input', function() {
          clearTimeout(timer);
          const val = input.value.trim();
          if (!val) {
            suggest.classList.add('hidden');
            suggest.innerHTML = '';
            return;
          }
          timer = setTimeout(async () => {
            const url = `https://api.twelvedata.com/symbol_search?symbol=${encodeURIComponent(val)}&apikey=30860e660a9e49b697b24a9bb38e8a58`;
            try {
              const res = await fetch(url);
              const data = await res.json();
              if (data.data && data.data.length > 0) {
                suggest.innerHTML = data.data.slice(0, 8).map(item =>
                  `<li class='px-4 py-2 hover:bg-blue-50 cursor-pointer' data-symbol='${item.symbol}' data-name='${item.instrument_name || item.name || ''}'>
                    <span class='font-semibold text-blue-600'>${item.symbol}</span> <span class='text-gray-500'>${item.instrument_name || item.name || ''}</span>
                  </li>`
                ).join('');
                suggest.classList.remove('hidden');
              } else {
                suggest.innerHTML = '<li class="px-4 py-2 text-gray-400">No result</li>';
                suggest.classList.remove('hidden');
              }
            } catch {
              suggest.innerHTML = '<li class="px-4 py-2 text-red-400">API Error</li>';
              suggest.classList.remove('hidden');
            }
          }, 300);
        });
        input.addEventListener('blur', () => setTimeout(() => suggest.classList.add('hidden'), 200));
        suggest.addEventListener('mousedown', function(e) {
          const li = e.target.closest('li[data-symbol]');
          if (li) {
            window.location.href = `stock.html?query=${encodeURIComponent(li.getAttribute('data-symbol'))}`;
          }
        });
        btn.onclick = function() {
          const keyword = input.value.trim();
          if (keyword) {
            window.location.href = `stock.html?query=${encodeURIComponent(keyword)}`;
          }
        };
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            btn.click();
          }
        });
      </script>

      <!-- 用户资料区（预留） -->
      <section id="userProfile" class="hidden">
        <h2 class="text-2xl font-bold text-gray-700 mb-4" data-i18n="userProfile">User Profile</h2>
        <!-- 用户信息表单、头像上传等 -->
      </section>
      <!-- 投资组合管理区（预留） -->
      <section id="portfolioManage" class="hidden">
        <h2 class="text-2xl font-bold text-gray-700 mb-4" data-i18n="portfolioManage">Portfolio Management</h2>
        <!-- 组合列表、重命名、删除、权限设置等 -->
      </section>
      <!-- 资产管理区（预留） -->
      <section id="assetManage" class="hidden">
        <h2 class="text-2xl font-bold text-gray-700 mb-4" data-i18n="assetManage">Asset Management</h2>
        <!-- 资产列表、添加、删除、分类等 -->
      </section>

      <!-- 仪表盘概览 -->
      <section id="dashboard">
        <!-- 实时行情滚动条 -->
        <div id="marketTicker" class="overflow-hidden whitespace-nowrap bg-white rounded shadow mb-6 h-10 flex items-center">
          <div id="tickerContent" class="animate-marquee text-blue-500 text-base font-semibold px-4">
            <span class="text-gray-500 text-xs">●</span>
            <span class="mx-6">Loading market data...</span>
          </div>
        </div>

        <!-- 全局加载状态 -->
        <div id="globalLoading" class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="flex items-center justify-center">
            <div class="text-blue-500 text-lg mr-3">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <span class="text-blue-700 font-medium">Loading portfolio data...</span>
          </div>
        </div>

        <h2 class="text-2xl font-bold text-gray-700 mb-4" data-i18n="portfolioOverview">Portfolio Overview</h2>
        <!-- 优化后的卡片布局 -->
         <!-- 投资组合概览统计卡片 -->
         <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
          <!-- 总资产价值卡片 -->
          <div class="bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-xl transform hover:-translate-y-1 border-l-4 border-blue-500">
              <div class="flex items-center justify-between mb-4">
                  <h3 class="text-gray-600 font-medium">Total Asset Value</h3>
                  <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-500">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                          <circle cx="12" cy="12" r="10"/>
                          <path d="M8 12h8M12 8v8"/>
                      </svg>
                  </div>
              </div>
              <div class="mb-2">
                  <span id="totalValue" class="text-3xl font-bold text-gray-800">$0</span>
              </div>
              <div class="flex items-center">
                  <span id="totalValueChange" class="text-green-600 text-sm font-medium flex items-center">
                      <i class="fa fa-arrow-up mr-1"></i> Loading...
                  </span>
              </div>
          </div>

          <!-- 总投资收益卡片 -->
          <div class="bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-xl transform hover:-translate-y-1 border-l-4 border-green-500">
              <div class="flex items-center justify-between mb-4">
                  <h3 class="text-gray-600 font-medium">Total Investment Profit</h3>
                  <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-500">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                          <polyline points="4 14 10 10 14 14 20 8"/>
                          <path d="M4 20h16"/>
                      </svg>
                  </div>
              </div>
              <div class="mb-2">
                  <span id="totalGain" class="text-3xl font-bold text-gray-800">$0</span>
              </div>
              <div class="flex items-center">
                  <span id="totalGainChange" class="text-green-600 text-sm font-medium flex items-center">
                      <i class="fa fa-arrow-up mr-1"></i> Loading...
                  </span>
              </div>
          </div>

          <!-- 现金余额卡片 -->
          <div class="bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-xl transform hover:-translate-y-1 border-l-4 border-yellow-500">
              <div class="flex items-center justify-between mb-4">
                  <h3 class="text-gray-600 font-medium">Cash Balance</h3>
                  <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-500">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                          <rect x="2" y="7" width="20" height="10" rx="2"/>
                          <circle cx="12" cy="12" r="3"/>
                      </svg>
                  </div>
              </div>
              <div class="mb-2">
                  <span id="cashBalance" class="text-3xl font-bold text-gray-800">$15,000</span>
              </div>
              <div class="flex items-center">
                  <span class="text-gray-500 text-sm font-medium flex items-center">
                      <i class="fa fa-minus mr-1"></i> No Change
                  </span>
              </div>
          </div>

          <!-- 年化收益率卡片 -->
          <div class="bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-xl transform hover:-translate-y-1 border-l-4 border-red-500">
              <div class="flex items-center justify-between mb-4">
                  <h3 class="text-gray-600 font-medium">Annual Return</h3>
                  <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-500">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                          <circle cx="12" cy="12" r="10"/>
                          <path d="M12 6v6l4 2"/>
                      </svg>
                  </div>
              </div>
              <div class="mb-2">
                  <span id="annualReturn" class="text-3xl font-bold text-gray-800">0%</span>
              </div>
              <div class="flex items-center">
                  <span id="annualReturnChange" class="text-red-600 text-sm font-medium flex items-center">
                      <i class="fa fa-arrow-down mr-1"></i> Loading...
                  </span>
              </div>
          </div>
      </div>
      </section>

      <!-- 资产分配页面 -->
      <!-- 增加与上方内容的间距 -->
      <section id="allocation" class="mt-12">
        <h2 class="text-2xl font-bold text-gray-700 mb-4" data-i18n="assetAllocation">Asset Allocation</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="asset-card p-6 relative">
            <div style="height: 340px; position: relative;">
              <canvas id="assetAllocationChart"></canvas>
              <!-- SVG连线层 -->
              <svg id="connectionLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;">
                <defs>
                  <filter id="glow">
                    <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                    <feMerge> 
                      <feMergeNode in="coloredBlur"/>
                      <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                  </filter>
                </defs>
              </svg>
            </div>
          </div>
          <div class="asset-card p-6 flex flex-col justify-center">
            <h3 class="text-lg font-bold mb-3" data-i18n="assetAllocationDetail">Asset Allocation Details</h3>
            <ul class="space-y-3 text-sm">
              <li class="flex items-center justify-center py-8">
                <div class="text-center">
                  <div class="text-gray-400 text-4xl mb-2">
                    <i class="fas fa-spinner fa-spin"></i>
                  </div>
                  <span class="text-gray-500 text-sm">Loading asset allocation...</span>
                </div>
              </li>
            </ul>
            <p class="text-gray-600 mt-4 text-sm" data-i18n="allocationTip">
              Reasonable allocation can reduce risk. It is recommended to adjust regularly according to the market and your risk tolerance.
            </p>
          </div>
        </div>
      </section>

      <!-- 持仓概况页面 -->
      <section id="positions" class="mt-12">
        <h2 class="text-2xl font-bold text-gray-700 mb-4" data-i18n="currentPositions">Current Positions</h2>

        <!-- 持仓列表 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="positionsList">
          <div class="col-span-full text-center py-12">
            <div class="text-gray-400 text-6xl mb-4">
              <i class="fas fa-spinner fa-spin"></i>
            </div>
            <h3 class="text-gray-600 font-medium mb-2">Loading Holdings</h3>
            <p class="text-gray-500 text-sm">Please wait while we fetch your portfolio data...</p>
          </div>
        </div>

        <!-- 显示更多按钮 -->
        <!-- <div class="mt-8 text-center">
          <button id="showMoreBtn" onclick="window.location.href='detail.html'"
            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" data-i18n="showMore">
            Show More <i class="fa fa-chevron-right ml-1"></i>
          </button>
        </div> -->
      </section>

      <!-- 弹窗组件 -->
      <div id="modal" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md relative">
          <button onclick="closeModal()"
            class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
          <div id="modalContent"> 
            <!-- 动态内容区域 -->
          </div>
        </div>
      </div>

      <script>
        function openModal(type) {
          const modal = document.getElementById('modal');
          const content = document.getElementById('modalContent');
          let html = '';
          if (type === 'newPortfolio') {
            html = `<h3 class="text-lg font-bold mb-4">新建投资组合</h3>
                <input class="border rounded px-3 py-2 w-full mb-4" placeholder="请输入组合名称">
                <button class="bg-blue-500 text-white px-4 py-2 rounded" onclick="alert('创建成功')">创建</button>`;
          } else if (type === 'userManage') {
            html = `<h3 class="text-lg font-bold mb-4">用户管理</h3>
                <p>这里可以进行用户列表、添加、删除等操作。</p>`;
          } else if (type === 'assetManage') {
            html = `<h3 class="text-lg font-bold mb-4">资产管理</h3>
                <p>这里可以管理资产类型、添加资产等。</p>`;
          } else if (type === 'portfolioManage') {
            html = `<h3 class="text-lg font-bold mb-4">投资组合管理</h3>
                <p>这里可以重命名、删除、设置权限等。</p>`;
          }
          content.innerHTML = html;
          modal.classList.remove('hidden');
        }

        function closeModal() {
          document.getElementById('modal').classList.add('hidden');
        }




        // 真实API数据拉取与滚动展示 - 优化版本
        let lastUpdateTime = 0;
        let cachedTickerData = null;
        const UPDATE_INTERVAL = 2 * 60 * 1000; // 2分钟
        const CACHE_DURATION = 5 * 60 * 1000; // 5分钟缓存有效期

        async function fetchMarketTicker() {
          const now = Date.now();

          // 检查是否需要更新数据
          if (cachedTickerData && (now - lastUpdateTime) < UPDATE_INTERVAL) {
            // 使用缓存数据，但更新时间显示
            displayTickerData(cachedTickerData, false);
            return;
          }

          const apiKey = '30860e660a9e49b697b24a9bb38e8a58';
          const symbols = ['AAPL', 'MSFT', 'TSLA', 'GOOGL', 'AMZN'];

          try {
            console.log('Fetching fresh market data...');

            // 使用Twelve Data API获取实时报价
            const promises = symbols.map(async (symbol) => {
              try {
                const response = await fetch(`https://api.twelvedata.com/quote?symbol=${symbol}&apikey=${apiKey}`);
                const data = await response.json();

                if (data.code === 429) {
                  console.warn('API rate limit reached, using cached data');
                  throw new Error('Rate limit');
                }

                if (data.code || data.status === 'error') {
                  return null; // 标记为失败
                }

                const changeValue = parseFloat(data.change || 0);
                const changePercent = parseFloat(data.percent_change || 0);
                const changeSign = changeValue >= 0 ? '+' : '';

                return {
                  symbol: data.symbol || symbol,
                  price: parseFloat(data.price || 0).toFixed(2),
                  change: `${changeSign}${changePercent.toFixed(2)}%`,
                  timestamp: now
                };
              } catch (error) {
                console.warn(`Failed to fetch ${symbol}:`, error.message);
                return null;
              }
            });

            const results = await Promise.all(promises);
            const validData = results.filter(item => item !== null);

            if (validData.length > 0) {
              // 更新缓存
              cachedTickerData = validData;
              lastUpdateTime = now;
              displayTickerData(validData, true);
            } else {
              // 所有API调用都失败，使用缓存或默认数据
              if (cachedTickerData && (now - lastUpdateTime) < CACHE_DURATION) {
                displayTickerData(cachedTickerData, false);
              } else {
                displayDefaultData();
              }
            }

          } catch (error) {
            console.error('Market ticker fetch error:', error);
            // 使用缓存数据或默认数据
            if (cachedTickerData && (now - lastUpdateTime) < CACHE_DURATION) {
              displayTickerData(cachedTickerData, false);
            } else {
              displayDefaultData();
            }
          }
        }

        function displayTickerData(data, isLive) {
          const statusIndicator = isLive ?
            '<span class="text-green-500 text-xs">●</span>' :
            '<span class="text-yellow-500 text-xs">●</span>';

          const ticker = data.map(item =>
            `<span class="mx-6">${item.symbol}: <span class="font-bold">$${item.price}</span> <span class="${item.change.startsWith('+') ? 'text-green-600' : 'text-red-600'}">${item.change}</span></span>`
          ).join('');

          const lastUpdateText = lastUpdateTime ?
            ` <span class="text-gray-400 text-xs ml-4">Last: ${new Date(lastUpdateTime).toLocaleTimeString()}</span>` : '';

          document.getElementById('tickerContent').innerHTML = statusIndicator + ticker + lastUpdateText;
        }

        function displayDefaultData() {
          const defaultData = [
            { symbol: 'AAPL', price: '192.34', change: '+1.23%' },
            { symbol: 'MSFT', price: '342.12', change: '-0.45%' },
            { symbol: 'TSLA', price: '245.67', change: '+0.89%' },
            { symbol: 'GOOGL', price: '156.78', change: '+0.29%' },
            { symbol: 'AMZN', price: '187.20', change: '+0.87%' }
          ];

          const ticker = defaultData.map(item =>
            `<span class="mx-6">${item.symbol}: <span class="font-bold">$${item.price}</span> <span class="${item.change.startsWith('+') ? 'text-green-600' : 'text-red-600'}">${item.change}</span></span>`
          ).join('');

          document.getElementById('tickerContent').innerHTML =
            '<span class="text-gray-500 text-xs">●</span>' + ticker +
            ' <span class="text-gray-400 text-xs ml-4">Demo Data</span>';
        }

        // 初始加载
        fetchMarketTicker();

        // 每30秒检查一次是否需要更新（但实际API调用间隔是2分钟）
        setInterval(fetchMarketTicker, 30000);

        // 真实数据加载函数 (使用management.html的逻辑)
        let portfolioData = [];
        const API_BASE_URL = 'http://localhost:3000/api';

        async function loadPortfolioData() {
          console.log('loadPortfolioData 函数开始执行');
          try {
            const userId = getCurrentUserId();
            console.log('Loading portfolio data for user:', userId);

            const response = await fetch(`${API_BASE_URL}/holdings/${userId}`);
            if (response.ok) {
              portfolioData = await response.json();
              console.log('Portfolio data loaded:', portfolioData);
              await updatePortfolioSummary(); // 更新统计数据
              updateHoldingsList(portfolioData).catch(error => {
                console.error('Failed to update holdings list:', error);
              });
            } else {
              console.error('Failed to load portfolio data, status:', response.status);
              portfolioData = [];
              updatePortfolioSummaryFallback(); // 显示默认数据
              showErrorState('Failed to load portfolio data from server');
              return;
            }

            // 旧的计算逻辑已移除，现在使用 updatePortfolioSummary() 函数

          } catch (error) {
            console.error('Error loading portfolio data:', error);
            portfolioData = [];
            updatePortfolioSummaryFallback(); // 显示默认数据
            showErrorState('Network error: Unable to connect to server');
          }
        }

        // 更新投资组合统计数据 (从management.html复制)
        async function updatePortfolioSummary() {
          try {
            let totalValue = 0;
            let totalCost = 0;
            let assetAllocation = {}; // 用于图表的资产分配数据

            // 计算总价值和总成本
            for (const holding of portfolioData) {
              try {
                // 尝试获取当前价格
                const priceResponse = await fetch(`${API_BASE_URL}/stock/price/${holding.ticker}`);
                let currentPrice = holding.buyin_price; // 默认使用买入价

                if (priceResponse.ok) {
                  const priceData = await priceResponse.json();
                  currentPrice = parseFloat(priceData.price) || holding.buyin_price;
                }

                const holdingValue = currentPrice * holding.quantity;
                const holdingCost = holding.buyin_price * holding.quantity;

                totalValue += holdingValue;
                totalCost += holdingCost;

                // 按资产类型累计价值
                const assetType = holding.type || 'other';
                if (!assetAllocation[assetType]) {
                  assetAllocation[assetType] = 0;
                }
                assetAllocation[assetType] += holdingValue;

              } catch (error) {
                console.warn(`Failed to get price for ${holding.ticker}:`, error);
                // 使用买入价作为后备
                const holdingValue = holding.buyin_price * holding.quantity;
                totalValue += holdingValue;
                totalCost += holdingValue;

                // 按资产类型累计价值
                const assetType = holding.type || 'other';
                if (!assetAllocation[assetType]) {
                  assetAllocation[assetType] = 0;
                }
                assetAllocation[assetType] += holdingValue;
              }
            }

            const totalGain = totalValue - totalCost;
            const annualReturn = totalCost > 0 ? ((totalGain / totalCost) * 100) : 0;
            const cashBalance = 15000; // 固定现金余额

            // 更新UI
            document.getElementById('totalValue').textContent = `$${totalValue.toLocaleString()}`;
            document.getElementById('totalGain').textContent = `${totalGain >= 0 ? '+' : ''}$${totalGain.toLocaleString()}`;
            document.getElementById('annualReturn').textContent = `${annualReturn.toFixed(2)}%`;
            document.getElementById('cashBalance').textContent = `$${cashBalance.toLocaleString()}`;

            // 更新颜色和图标
            const gainElement = document.getElementById('totalGain');
            const gainChangeElement = document.getElementById('totalGainChange');
            const returnChangeElement = document.getElementById('annualReturnChange');

            if (totalGain >= 0) {
              gainElement.className = 'text-3xl font-bold text-green-600';
              gainChangeElement.innerHTML = '<i class="fa fa-arrow-up mr-1"></i> Profit';
              gainChangeElement.className = 'text-green-600 text-sm font-medium flex items-center';
            } else {
              gainElement.className = 'text-3xl font-bold text-red-600';
              gainChangeElement.innerHTML = '<i class="fa fa-arrow-down mr-1"></i> Loss';
              gainChangeElement.className = 'text-red-600 text-sm font-medium flex items-center';
            }

            if (annualReturn >= 0) {
              returnChangeElement.innerHTML = '<i class="fa fa-arrow-up mr-1"></i> Positive';
              returnChangeElement.className = 'text-green-600 text-sm font-medium flex items-center';
            } else {
              returnChangeElement.innerHTML = '<i class="fa fa-arrow-down mr-1"></i> Negative';
              returnChangeElement.className = 'text-red-600 text-sm font-medium flex items-center';
            }

            document.getElementById('totalValueChange').innerHTML = '<i class="fa fa-refresh mr-1"></i> Updated';

            // 更新图表数据
            updateChartData(assetAllocation, totalValue);

            // 更新持仓列表
            updatePositionsList();

            // 隐藏全局加载状态
            hideGlobalLoading();

          } catch (error) {
            console.error('Error updating portfolio summary:', error);
            updatePortfolioSummaryFallback();
          }
        }

        // 后备统计数据 (从management.html复制)
        function updatePortfolioSummaryFallback() {
          document.getElementById('totalValue').textContent = '$0';
          document.getElementById('totalGain').textContent = '$0';
          document.getElementById('annualReturn').textContent = '0%';
          document.getElementById('cashBalance').textContent = '$15,000';
          document.getElementById('totalValueChange').innerHTML = '<i class="fa fa-minus mr-1"></i> No Data';
          document.getElementById('totalGainChange').innerHTML = '<i class="fa fa-minus mr-1"></i> No Data';
          document.getElementById('annualReturnChange').innerHTML = '<i class="fa fa-minus mr-1"></i> No Data';

          // 重置图表为默认数据
          updateChartData({}, 0);

          // 重置持仓列表
          updatePositionsList();

          // 隐藏全局加载状态
          hideGlobalLoading();
        }

        // 全局图表变量
        let assetAllocationChart = null;
        let chartInitialized = false;

        // 隐藏全局加载状态
        function hideGlobalLoading() {
          const loadingElement = document.getElementById('globalLoading');
          if (loadingElement) {
            loadingElement.style.display = 'none';
          }
        }

        // 显示全局加载状态
        function showGlobalLoading() {
          const loadingElement = document.getElementById('globalLoading');
          if (loadingElement) {
            loadingElement.style.display = 'block';
          }
        }

        // 显示错误状态
        function showErrorState(message = 'Failed to load data') {
          const loadingElement = document.getElementById('globalLoading');
          if (loadingElement) {
            loadingElement.innerHTML = `
              <div class="flex items-center justify-center">
                <div class="text-red-500 text-lg mr-3">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <span class="text-red-700 font-medium">${message}</span>
                <button onclick="location.reload()" class="ml-4 px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                  Retry
                </button>
              </div>
            `;
            loadingElement.className = 'mb-6 bg-red-50 border border-red-200 rounded-lg p-4';
          }
        }

        // 更新图表数据的函数
        function updateChartData(assetAllocation, totalValue) {
          console.log('Updating chart data:', assetAllocation, 'Total value:', totalValue);

          // 如果图表还没初始化，等待一下再尝试
          if (!chartInitialized) {
            console.log('Chart not initialized yet, waiting...');
            setTimeout(() => updateChartData(assetAllocation, totalValue), 500);
            return;
          }

          // 资产类型映射和颜色配置
          const assetTypeMap = {
            'stock': { label: 'Stocks', color: 'rgba(54, 162, 235, 0.8)', borderColor: 'rgba(54, 162, 235, 1)' },
            'fund': { label: 'Funds', color: 'rgba(75, 192, 192, 0.8)', borderColor: 'rgba(75, 192, 192, 1)' },
            'bond': { label: 'Bonds', color: 'rgba(255, 205, 86, 0.8)', borderColor: 'rgba(255, 205, 86, 1)' },
            'gold': { label: 'Gold', color: 'rgba(153, 102, 255, 0.8)', borderColor: 'rgba(153, 102, 255, 1)' },
            'currency': { label: 'Currency', color: 'rgba(255, 99, 132, 0.8)', borderColor: 'rgba(255, 99, 132, 1)' },
            'other': { label: 'Others', color: 'rgba(201, 203, 207, 0.8)', borderColor: 'rgba(201, 203, 207, 1)' }
          };

          let labels = [];
          let data = [];
          let backgroundColors = [];
          let borderColors = [];
          let hoverBackgroundColors = [];

          if (totalValue > 0) {
            // 使用真实数据
            Object.keys(assetAllocation).forEach(assetType => {
              const value = assetAllocation[assetType];
              const percentage = ((value / totalValue) * 100).toFixed(1);

              const config = assetTypeMap[assetType] || assetTypeMap['other'];
              labels.push(config.label);
              data.push(parseFloat(percentage));
              backgroundColors.push(config.color);
              borderColors.push(config.borderColor);
              hoverBackgroundColors.push(config.borderColor);
            });
          } else {
            // 使用默认数据
            labels = ['No Data'];
            data = [100];
            backgroundColors = ['rgba(201, 203, 207, 0.8)'];
            borderColors = ['rgba(201, 203, 207, 1)'];
            hoverBackgroundColors = ['rgba(201, 203, 207, 1)'];
          }

          // 更新图表
          if (assetAllocationChart) {
            assetAllocationChart.data.labels = labels;
            assetAllocationChart.data.datasets[0].data = data;
            assetAllocationChart.data.datasets[0].backgroundColor = backgroundColors;
            assetAllocationChart.data.datasets[0].borderColor = borderColors;
            assetAllocationChart.data.datasets[0].hoverBackgroundColor = hoverBackgroundColors;
            assetAllocationChart.update();
            console.log('Chart updated with real data');
          }

          // 同时更新右侧的资产分配详情列表
          updateAssetAllocationDetails(labels, data, backgroundColors);
        }

        // 更新资产分配详情列表
        function updateAssetAllocationDetails(labels, data, colors) {
          const detailsContainer = document.querySelector('.asset-card ul');
          if (!detailsContainer) return;

          let detailsHTML = '';

          if (labels.length === 1 && labels[0] === 'No Data') {
            detailsHTML = `
              <li class="flex items-center justify-center py-8">
                <span class="text-gray-500">No portfolio data available</span>
              </li>
            `;
          } else {
            labels.forEach((label, index) => {
              const percentage = data[index];
              const color = colors[index];

              // 从rgba颜色提取RGB值用于CSS
              const rgbMatch = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
              const rgbColor = rgbMatch ? `rgb(${rgbMatch[1]}, ${rgbMatch[2]}, ${rgbMatch[3]})` : color;

              detailsHTML += `
                <li class="flex items-center justify-between">
                  <span class="w-16" style="color: ${rgbColor}">● ${label}</span>
                  <div class="flex-1 mx-3">
                    <div class="bg-gray-200 rounded-full h-2">
                      <div class="h-2 rounded-full" style="width: ${percentage}%; background-color: ${rgbColor}"></div>
                    </div>
                  </div>
                  <span class="w-12 text-right">${percentage}%</span>
                </li>
              `;
            });
          }

          detailsContainer.innerHTML = detailsHTML;
        }

        // 更新持仓列表（显示前6个最大持仓）
        async function updatePositionsList() {
          const positionsContainer = document.getElementById('positionsList');
          if (!positionsContainer || !portfolioData || portfolioData.length === 0) {
            if (positionsContainer) {
              positionsContainer.innerHTML = `
                <div class="col-span-full text-center py-12">
                  <div class="text-gray-400 text-6xl mb-4">
                    <i class="fas fa-chart-pie"></i>
                  </div>
                  <h3 class="text-gray-600 font-medium mb-2">No Holdings Found</h3>
                  <p class="text-gray-500 text-sm">Start building your portfolio by adding some investments</p>
                </div>
              `;
            }
            return;
          }

          // 计算每个持仓的当前价值并排序
          const enrichedHoldings = [];

          for (const holding of portfolioData) {
            try {
              // 获取当前价格
              const priceResponse = await fetch(`${API_BASE_URL}/stock/price/${holding.ticker}`);
              let currentPrice = holding.buyin_price;

              if (priceResponse.ok) {
                const priceData = await priceResponse.json();
                currentPrice = parseFloat(priceData.price) || holding.buyin_price;
              }

              const currentValue = currentPrice * holding.quantity;
              const totalCost = holding.buyin_price * holding.quantity;
              const profit = currentValue - totalCost;
              const profitPercent = totalCost > 0 ? ((profit / totalCost) * 100) : 0;

              enrichedHoldings.push({
                ...holding,
                currentPrice,
                currentValue,
                profit,
                profitPercent
              });
            } catch (error) {
              console.warn(`Failed to get price for ${holding.ticker}:`, error);
              const currentValue = holding.buyin_price * holding.quantity;
              enrichedHoldings.push({
                ...holding,
                currentPrice: holding.buyin_price,
                currentValue,
                profit: 0,
                profitPercent: 0
              });
            }
          }

          // 按当前价值排序，取前6个
          const topHoldings = enrichedHoldings
            .sort((a, b) => b.currentValue - a.currentValue)
            .slice(0, 6);

          let positionsHTML = '';

          topHoldings.forEach(holding => {
            const profitColor = holding.profit >= 0 ? 'text-green-600' : 'text-red-600';
            const profitIcon = holding.profit >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            const profitSign = holding.profit >= 0 ? '+' : '';

            // 资产类型颜色映射
            const typeColors = {
              'stock': 'bg-blue-100 text-blue-800',
              'fund': 'bg-green-100 text-green-800',
              'bond': 'bg-yellow-100 text-yellow-800',
              'gold': 'bg-purple-100 text-purple-800',
              'currency': 'bg-pink-100 text-pink-800'
            };
            const typeColorClass = typeColors[holding.type] || 'bg-gray-100 text-gray-800';

            positionsHTML += `
              <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 border-l-4 border-blue-500">
                <div class="flex justify-between items-start mb-4">
                  <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-1">${holding.name}</h3>
                    <div class="flex items-center space-x-2">
                      <span class="text-sm font-mono text-gray-600 bg-gray-100 px-2 py-1 rounded">${holding.ticker}</span>
                      <span class="px-2 py-1 rounded-full text-xs font-semibold ${typeColorClass}">
                        ${holding.type.charAt(0).toUpperCase() + holding.type.slice(1)}
                      </span>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-lg font-bold text-gray-900">$${holding.currentValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                    <div class="${profitColor} text-sm font-medium flex items-center justify-end">
                      <i class="fas ${profitIcon} mr-1"></i>
                      ${profitSign}${holding.profitPercent.toFixed(2)}%
                    </div>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                  <div>
                    <span class="font-medium">Quantity:</span>
                    <span class="text-gray-900">${holding.quantity.toLocaleString()}</span>
                  </div>
                  <div>
                    <span class="font-medium">Avg Price:</span>
                    <span class="text-gray-900">$${holding.buyin_price.toFixed(2)}</span>
                  </div>
                  <div>
                    <span class="font-medium">Current:</span>
                    <span class="text-gray-900 current-price" data-ticker="${holding.ticker}">$${holding.currentPrice.toFixed(2)}</span>
                  </div>
                  <div>
                    <span class="font-medium">P&L:</span>
                    <span class="${profitColor} profit-loss" data-ticker="${holding.ticker}">${profitSign}$${Math.abs(holding.profit).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                  </div>
                </div>
              </div>
            `;
          });

          positionsContainer.innerHTML = positionsHTML;
        }

        // 旧的后备数据函数已被 updatePortfolioSummaryFallback 替代

        // 获取当前用户ID (与management.html一致)
        function getCurrentUserId() {
          let userId = localStorage.getItem('currentUserId');
          if (!userId) {
            userId = '1'; // 默认用户ID，与management.html一致
            localStorage.setItem('currentUserId', userId);
            console.log('设置默认用户ID:', userId);
          }
          console.log('当前用户ID:', userId);
          return userId;
        }

        // 更新持仓列表
        async function updateHoldingsList(holdings) {
          const positionsList = document.getElementById('positionsList');

          if (!holdings || holdings.length === 0) {
            positionsList.innerHTML = `
              <div class="col-span-full text-center py-12">
                <div class="text-gray-400 text-lg mb-2">
                  <i class="fas fa-chart-line text-4xl mb-4"></i>
                </div>
                <h3 class="text-gray-600 font-medium mb-2">No Holdings Found</h3>
                <p class="text-gray-500 text-sm">Start investing to see your portfolio here</p>
                <a href="stock.html" class="inline-block mt-4 bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition">
                  Explore Stocks
                </a>
              </div>
            `;
            return;
          }

          let holdingsHTML = '';

          for (const holding of holdings) {
            try {
              // 获取当前价格和变化
              let currentPrice = holding.buyin_price;
              let priceChange = 0;
              let priceChangePercent = 0;

              try {
                const priceResponse = await fetch(`${API_BASE_URL}/stock/price/${holding.ticker}`);
                if (priceResponse.ok) {
                  const priceData = await priceResponse.json();
                  currentPrice = parseFloat(priceData.price) || holding.buyin_price;
                  priceChange = currentPrice - holding.buyin_price;
                  priceChangePercent = ((priceChange / holding.buyin_price) * 100);
                }
              } catch (error) {
                console.warn(`Failed to get current price for ${holding.ticker}`);
              }

              const totalValue = currentPrice * holding.quantity;
              const totalCost = holding.buyin_price * holding.quantity;
              const totalGain = totalValue - totalCost;
              const gainPercent = ((totalGain / totalCost) * 100);

              const isPositive = gainPercent >= 0;
              const changeClass = isPositive ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600';
              const changeIcon = isPositive ? '+' : '';

              holdingsHTML += `
                <div class="bg-white rounded-xl shadow-md overflow-hidden transition-all duration-300 hover:shadow-xl transform hover:-translate-y-1 flex flex-col">
                  <div class="p-4 flex flex-col gap-2">
                    <div class="flex justify-between items-center mb-2">
                      <div>
                        <h3 class="font-bold text-lg">${holding.name || holding.ticker}</h3>
                        <span class="text-gray-400 text-xs font-mono">${holding.ticker}</span>
                      </div>
                      <div class="${changeClass} px-2 py-1 rounded text-xs font-medium">
                        ${changeIcon}${gainPercent.toFixed(2)}%
                      </div>
                    </div>
                    <div class="grid grid-cols-3 gap-x-2 mb-2">
                      <div>
                        <div class="text-gray-500 text-xs">Holding</div>
                        <div class="font-bold text-base">${holding.quantity.toLocaleString()}</div>
                      </div>
                      <div>
                        <div class="text-gray-500 text-xs">Avg Cost</div>
                        <div class="font-bold text-base">$${holding.buyin_price.toFixed(2)}</div>
                      </div>
                      <div>
                        <div class="text-gray-500 text-xs">Current</div>
                        <div class="font-bold text-base">$${currentPrice.toFixed(2)}</div>
                      </div>
                    </div>
                    <div class="grid grid-cols-2 gap-x-2">
                      <div>
                        <div class="text-gray-500 text-xs">Market Value</div>
                        <div class="font-bold text-base">$${totalValue.toLocaleString()}</div>
                      </div>
                      <div>
                        <div class="text-gray-500 text-xs">P&L</div>
                        <div class="font-bold text-base ${isPositive ? 'text-green-600' : 'text-red-600'}">
                          ${changeIcon}$${Math.abs(totalGain).toLocaleString()}
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="bg-gray-50 px-4 py-2">
                    <div class="text-gray-500 text-sm">
                      Proportion ${((totalValue / getTotalPortfolioValue()) * 100).toFixed(1)}%
                    </div>
                  </div>
                </div>
              `;
            } catch (error) {
              console.error(`Error processing holding ${holding.ticker}:`, error);
            }
          }

          // 添加Show More按钮
          holdingsHTML += `
            <div class="col-span-full mt-8 text-center">
              <button onclick="window.location.href='detail.html'"
                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                Show More <i class="fa fa-chevron-right ml-1"></i>
              </button>
            </div>
          `;

          positionsList.innerHTML = holdingsHTML;
        }

        // 获取投资组合总价值（用于计算比例）
        function getTotalPortfolioValue() {
          const totalValueText = document.getElementById('totalValue').textContent;
          return parseFloat(totalValueText.replace(/[$,]/g, '')) || 1;
        }

        // 实时更新Current Positions的价格数据（不重新渲染整个列表）
        async function updateCurrentPositionsPrices() {
          if (!portfolioData || portfolioData.length === 0) {
            return;
          }

          console.log('🔄 更新Current Positions实时价格...');

          try {
            // 获取前6个最大持仓
            const enrichedHoldings = [];

            for (const holding of portfolioData) {
              try {
                // 获取当前价格
                const priceResponse = await fetch(`${API_BASE_URL}/stock/price/${holding.ticker}`);
                let currentPrice = holding.buyin_price;

                if (priceResponse.ok) {
                  const priceData = await priceResponse.json();
                  currentPrice = parseFloat(priceData.price) || holding.buyin_price;
                }

                const currentValue = currentPrice * holding.quantity;
                const totalCost = holding.buyin_price * holding.quantity;
                const profit = currentValue - totalCost;
                const profitPercent = totalCost > 0 ? ((profit / totalCost) * 100) : 0;

                enrichedHoldings.push({
                  ...holding,
                  currentPrice,
                  currentValue,
                  profit,
                  profitPercent
                });
              } catch (error) {
                console.warn(`Failed to get price for ${holding.ticker}:`, error);
                const currentValue = holding.buyin_price * holding.quantity;
                enrichedHoldings.push({
                  ...holding,
                  currentPrice: holding.buyin_price,
                  currentValue,
                  profit: 0,
                  profitPercent: 0
                });
              }
            }

            // 按当前价值排序，取前6个
            const topHoldings = enrichedHoldings
              .sort((a, b) => b.currentValue - a.currentValue)
              .slice(0, 6);

            // 更新页面上的价格显示
            topHoldings.forEach(holding => {
              const currentPriceElement = document.querySelector(`[data-ticker="${holding.ticker}"] .current-price`);
              const profitLossElement = document.querySelector(`[data-ticker="${holding.ticker}"] .profit-loss`);

              if (currentPriceElement) {
                const oldPrice = parseFloat(currentPriceElement.textContent.replace('$', ''));
                currentPriceElement.textContent = `$${holding.currentPrice.toFixed(2)}`;

                // 如果价格有变化，添加闪烁效果
                if (Math.abs(oldPrice - holding.currentPrice) > 0.01) {
                  currentPriceElement.classList.add('price-updated');
                  setTimeout(() => {
                    currentPriceElement.classList.remove('price-updated');
                  }, 1000);
                }
              }

              if (profitLossElement) {
                const profitSign = holding.profit >= 0 ? '+' : '';
                const profitColor = holding.profit >= 0 ? 'text-green-600' : 'text-red-600';
                profitLossElement.textContent = `${profitSign}$${Math.abs(holding.profit).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                profitLossElement.className = `${profitColor} profit-loss`;
                profitLossElement.setAttribute('data-ticker', holding.ticker);
              }
            });

            console.log('✅ Current Positions价格更新完成');
          } catch (error) {
            console.error('❌ Current Positions价格更新失败:', error);
          }
        }

        // showLoadingState 函数已移除，使用 management.html 的加载逻辑

        // 页面加载时调用
        document.addEventListener('DOMContentLoaded', function() {
          console.log('页面加载完成，开始初始化...');

          // 确保显示加载状态
          showGlobalLoading();

          checkLoginStatus(); // 先检查登录状态

          console.log('开始加载投资组合数据...');
          loadPortfolioData(); // 然后加载投资组合数据

          // 启动定时更新机制
          // 每2分钟完整更新一次所有数据
          setInterval(async () => {
            console.log('定时完整更新投资组合数据...');
            try {
              await updatePortfolioSummary(); // 更新统计数据和持仓列表
            } catch (error) {
              console.error('定时完整更新失败:', error);
            }
          }, 120000); // 2分钟 = 120000毫秒

          // 每30秒更新一次Current Positions的价格（轻量级更新）
          setInterval(async () => {
            try {
              await updateCurrentPositionsPrices();
            } catch (error) {
              console.error('Current Positions价格更新失败:', error);
            }
          }, 30000); // 30秒 = 30000毫秒
        });

        // 绘制资产分配饼状图
        document.addEventListener('DOMContentLoaded', function () {
          const ctx = document.getElementById('assetAllocationChart').getContext('2d');
          const connectionLayer = document.getElementById('connectionLayer');
          let currentConnection = null;

          // 选中变大功能
          let activeIndex = null;

          // 初始默认数据（将被真实数据替换）
          const assetData = {
            labels: ['Loading...'],
            datasets: [{
              data: [100],
              backgroundColor: ['rgba(201, 203, 207, 0.8)'],
              borderColor: ['rgba(201, 203, 207, 1)'],
              borderWidth: 2,
              hoverBackgroundColor: ['rgba(201, 203, 207, 1)'],
              hoverOffset: 15
            }]
          };

          // 修正选中放大后显示不全：动态调整canvas父容器高度和canvas高度
          const chartContainer = document.getElementById('assetAllocationChart').parentNode;
          chartContainer.style.height = '340px';
          document.getElementById('assetAllocationChart').height = 340;

          // 创建图表并保存到全局变量
          assetAllocationChart = new Chart(ctx, {
            type: 'pie',
            data: assetData,
            options: {
              responsive: true,
              maintainAspectRatio: false,
              layout: {
                padding: {
                  top: 20,
                  bottom: 20,
                  left: 20,
                  right: 20
                }
              },
              plugins: {
                legend: {
                  display: false // 隐藏图例
                },
                tooltip: {
                  enabled: false // 禁用默认tooltip
                }
              },
              // 悬停选中放大
              onHover: function (event, elements, chart) {
                if (elements.length > 0) {
                  const index = elements[0].index;
                  
                  // 检查是否已经在显示同一个扇形
                  if (activeIndex !== index) {
                    activeIndex = index;
                    chart.setActiveElements([{
                      datasetIndex: elements[0].datasetIndex,
                      index: index
                    }]);
                    
                    // 显示高亮和虚折线
                    showHighlightAndLine(index, chart);
                  }
                } else {
                  // 鼠标离开所有扇形时才清除
                  if (activeIndex !== null) {
                    activeIndex = null;
                    chart.setActiveElements([]);
                    clearHighlightAndLine();
                  }
                }
                chart.update();
              },
              animation: {
                animateRotate: true,
                animateScale: true
              }
            }
          });

          // 等待图表渲染完成后初始化
          setTimeout(() => {
            chartInitialized = true;
            console.log('Chart initialized, ready for data updates');
          }, 500);

          // 显示高亮和虚折线函数
          function showHighlightAndLine(index, chart) {
            clearHighlightAndLine();
            
            const canvas = document.getElementById('assetAllocationChart');
            const chartArea = chart.chartArea;
            
            // 计算饼图扇形中心角度
            const chartData = chart.data.datasets[0].data;
            const total = chartData.reduce((a, b) => a + b, 0);
            let currentAngle = -Math.PI / 2; // 从12点钟方向开始
            for (let i = 0; i < index; i++) {
              currentAngle += (chartData[i] / total) * 2 * Math.PI;
            }
            const sliceAngle = (chartData[index] / total) * 2 * Math.PI;
            const midAngle = currentAngle + sliceAngle / 2;
            
            // 计算饼图中心点
            const pieCenterX = chartArea.left + (chartArea.right - chartArea.left) / 2;
            const pieCenterY = chartArea.top + (chartArea.bottom - chartArea.top) / 2;
            
            // 计算饼图半径
            const pieRadius = Math.min(chartArea.right - chartArea.left, chartArea.bottom - chartArea.top) * 0.4;
            
            // 计算扇形的几何中心点（质心）- 距离中心2/3半径处
            const centroidRadius = pieRadius * 0.67;
            const centroidX = pieCenterX + Math.cos(midAngle) * centroidRadius;
            const centroidY = pieCenterY + Math.sin(midAngle) * centroidRadius;
            
            // 计算折线路径点 - 先向外延伸到饼图外部，再水平延伸
            let cornerX, cornerY, endX, endY;
            let textX, textY;
            
            // 将角度转换为度数，便于判断方向
            const angleDegrees = (midAngle * 180) / Math.PI;
            
            // 第一段：从质心沿着扇形方向延伸到饼图外部
            const outwardDistance = pieRadius + 45; // 延伸到饼图外45像素
            const outwardX = pieCenterX + Math.cos(midAngle) * outwardDistance;
            const outwardY = pieCenterY + Math.sin(midAngle) * outwardDistance;
            
            if (angleDegrees >= -45 && angleDegrees < 45) {
              // 右侧扇形：向右水平延伸
              cornerX = outwardX;
              cornerY = outwardY;
              endX = cornerX + 60;
              endY = cornerY;
              textX = endX + 6;
              textY = endY + 4;
            } else if (angleDegrees >= 45 && angleDegrees < 135) {
              // 下方扇形：统一向左水平延伸（紫色部分往左）
              cornerX = outwardX;
              cornerY = outwardY;
              endX = cornerX - 60;
              endY = cornerY;
              textX = endX - 50;
              textY = endY + 4;
              
              // 专门为紫色部分（CCY）调整位置
              if (index === 4) { // CCY是第5个元素，索引为4
                endX = cornerX - 60;
                endY = cornerY - 10;
                textX = endX - 35;
                textY = endY - 5;
              }
            } else if (angleDegrees >= 135 || angleDegrees < -135) {
              // 左侧扇形：向左水平延伸
              cornerX = outwardX;
              cornerY = outwardY;
              endX = cornerX - 60;
              endY = cornerY;
              textX = endX - 50;
              textY = endY + 4;
            } else {
              // 上方扇形：向上垂直延伸
              cornerX = outwardX;
              cornerY = outwardY;
              endX = cornerX;
              endY = cornerY - 60;
              textX = endX + 8;
              textY = endY - 8;
            }
            
            // 创建折线路径点：质心 -> 饼图外部 -> 水平/垂直延伸
            const points = `${centroidX},${centroidY} ${cornerX},${cornerY} ${endX},${endY}`;
            
            // 创建SVG折线
            const polyline = document.createElementNS('http://www.w3.org/2000/svg', 'polyline');
            polyline.setAttribute('points', points);
            polyline.setAttribute('stroke', chart.data.datasets[0].borderColor[index]); // 使用更深的边框颜色
            polyline.setAttribute('stroke-width', '2'); // 减小线条宽度
            polyline.setAttribute('stroke-dasharray', 'none'); // 改为实线
            polyline.setAttribute('fill', 'none');
            polyline.setAttribute('opacity', '0.9'); // 增加透明度
            polyline.id = 'highlight-line';
            
            // 添加动画效果 - 使用stroke-dasharray实现逐渐伸出
            const totalLength = Math.sqrt(Math.pow(cornerX - centroidX, 2) + Math.pow(cornerY - centroidY, 2)) + 
                               Math.sqrt(Math.pow(endX - cornerX, 2) + Math.pow(endY - cornerY, 2));
            polyline.style.strokeDasharray = `0,${totalLength}`;
            polyline.style.transition = 'stroke-dasharray 0.6s ease-in-out';
            
            connectionLayer.appendChild(polyline);
            
            // 延迟执行动画
            setTimeout(() => {
              polyline.style.strokeDasharray = `${totalLength},0`;
            }, 50);
            
            // 创建占比文本（带淡入动画）
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', textX);
            text.setAttribute('y', textY);
            text.setAttribute('font-family', 'Arial, sans-serif');
            text.setAttribute('font-size', '16');
            text.setAttribute('font-weight', 'bold');
            text.setAttribute('fill', chart.data.datasets[0].backgroundColor[index]);
            text.textContent = `${chart.data.labels[index]}: ${chart.data.datasets[0].data[index]}%`;
            text.id = 'highlight-text';
            text.style.opacity = '0';
            text.style.transition = 'opacity 0.4s ease-in-out';
            
            connectionLayer.appendChild(text);
            
            // 延迟显示文本
            setTimeout(() => {
              text.style.opacity = '1';
            }, 300);
          }

          // 清除高亮和虚折线
          function clearHighlightAndLine() {
            const line = document.getElementById('highlight-line');
            const text = document.getElementById('highlight-text');
            
            if (line && line.parentNode) {
              line.parentNode.removeChild(line);
            }
            if (text && text.parentNode) {
              text.parentNode.removeChild(text);
            }
          }

          // 清除连线
          function clearConnection() {
            const lines = connectionLayer.querySelectorAll('line');
            lines.forEach(line => {
              if (line.parentNode) {
                line.parentNode.removeChild(line);
              }
            });
            const texts = connectionLayer.querySelectorAll('text');
            texts.forEach(text => {
              if (text.parentNode) {
                text.parentNode.removeChild(text);
              }
            });
          }
        });

        // 侧边栏收起/展开功能
        let sidebarCollapsed = false;
        function toggleSidebar() {
          sidebarCollapsed = !sidebarCollapsed;
          const sidebar = document.getElementById('sidebar');
          const main = document.getElementById('mainContent');
          const texts = sidebar.querySelectorAll('.sidebar-text');
          if (sidebarCollapsed) {
            sidebar.classList.remove('w-48');
            sidebar.classList.add('w-16');
            main.classList.remove('md:ml-48');
            main.classList.add('md:ml-16');
            texts.forEach(t => t.classList.add('hidden'));
            document.getElementById('sidebarToggleIcon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />';
          } else {
            sidebar.classList.remove('w-16');
            sidebar.classList.add('w-48');
            main.classList.remove('md:ml-16');
            main.classList.add('md:ml-48');
            texts.forEach(t => t.classList.remove('hidden'));
            document.getElementById('sidebarToggleIcon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 12H5" />';
          }
        }
        // 页面加载后初始化一次，防止刷新后状态不同步
        document.addEventListener('DOMContentLoaded', function() {
          const sidebar = document.getElementById('sidebar');
          const texts = sidebar.querySelectorAll('.sidebar-text');
          if (sidebarCollapsed) {
            texts.forEach(t => t.classList.add('hidden'));
          } else {
            texts.forEach(t => t.classList.remove('hidden'));
          }
        });
      </script>
</body>

</html>