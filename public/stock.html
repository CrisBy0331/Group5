<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- <script src="js/api.js"></script>
  <script src="js/trading.js"></script> -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* 价格变化动画 */
    @keyframes priceUp {
      0% {
        background-color: rgba(34, 197, 94, 0.1);
      }

      100% {
        background-color: transparent;
      }
    }

    @keyframes priceDown {
      0% {
        background-color: rgba(239, 68, 68, 0.1);
      }

      100% {
        background-color: transparent;
      }
    }

    .price-up {
      animation: priceUp 1s ease-out;
    }

    .price-down {
      animation: priceDown 1s ease-out;
    }

    /* 按钮悬停效果 */
    .btn-hover-effect {
      position: relative;
      overflow: hidden;
    }

    .btn-hover-effect::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-hover-effect:hover::before {
      left: 100%;
    }

    /* 卡片悬停效果 */
    .info-card {
      transition: all 0.3s ease;
    }

    .info-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    /* 加载骨架屏 */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 text-gray-800 min-h-screen">
  <!-- 顶部导航 -->
  <header class="bg-white shadow h-16 px-6 flex justify-between items-center sticky top-0 z-50">
    <!-- Left: Logo and platform name -->
    <a href="index.html" class="flex items-center space-x-4 group cursor-pointer select-none">
      <!-- Logo icon -->
      <svg class="w-9 h-9 text-blue-400 group-hover:text-blue-600 transition" fill="none" stroke="currentColor"
        stroke-width="2" viewBox="0 0 32 32">
        <circle cx="16" cy="16" r="13" stroke="currentColor" stroke-width="2" fill="#e0f2fe" />
        <path d="M10 20c2-4 10-4 12 0" stroke="#38bdf8" stroke-width="2" fill="none" />
        <path d="M16 10v8" stroke="#2563eb" stroke-width="2" stroke-linecap="round" />
        <circle cx="16" cy="10" r="2" fill="#2563eb" />
      </svg>
      <span
        class="text-2xl font-extrabold text-blue-400 group-hover:text-blue-600 tracking-wide transition leading-none"
        style="letter-spacing: 1px;">
        Future Assets
      </span>
    </a>
    <!-- Right: User area -->
    <div class="flex items-center space-x-4">
      <div id="userArea">
        <!-- 这里会被JavaScript动态更新 -->
      </div>
    </div>
  </header>
  <!-- 居中搜索框 -->
  <div class="w-full flex mb-8 mt-6">
    <div class="mx-auto w-96 relative">
      <input id="stockSearchInput" type="text" placeholder="Search stock code or name..."
        class="w-full px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-200 text-base"
        autocomplete="off" />
      <button id="stockSearchBtn"
        class="absolute right-0 top-0 h-full px-5 bg-blue-500 text-white rounded-r-lg hover:bg-blue-600 transition">Search</button>
      <ul id="stockSearchSuggest"
        class="absolute left-0 top-full w-full bg-white border border-gray-200 rounded-b-lg shadow z-10 hidden max-h-60 overflow-y-auto">
      </ul>
    </div>
  </div>
  <script>
    const input = document.getElementById('stockSearchInput');
    const btn = document.getElementById('stockSearchBtn');
    const suggest = document.getElementById('stockSearchSuggest');
    let timer = null;
    input.addEventListener('input', function () {
      clearTimeout(timer);
      const val = input.value.trim();
      if (!val) {
        suggest.classList.add('hidden');
        suggest.innerHTML = '';
        return;
      }
      timer = setTimeout(async () => {
        const url = `https://api.twelvedata.com/symbol_search?symbol=${encodeURIComponent(val)}&apikey=30860e660a9e49b697b24a9bb38e8a58`;
        try {
          const res = await fetch(url);
          const data = await res.json();
          if (data.data && data.data.length > 0) {
            suggest.innerHTML = data.data.slice(0, 8).map(item =>
              `<li class='px-4 py-2 hover:bg-blue-50 cursor-pointer' data-symbol='${item.symbol}' data-name='${item.instrument_name || item.name || ''}'>
                <span class='font-semibold text-blue-600'>${item.symbol}</span> <span class='text-gray-500'>${item.instrument_name || item.name || ''}</span>
              </li>`
            ).join('');
            suggest.classList.remove('hidden');
          } else {
            suggest.innerHTML = '<li class="px-4 py-2 text-gray-400">No result</li>';
            suggest.classList.remove('hidden');
          }
        } catch {
          suggest.innerHTML = '<li class="px-4 py-2 text-red-400">API Error</li>';
          suggest.classList.remove('hidden');
        }
      }, 300);
    });
    input.addEventListener('blur', () => setTimeout(() => suggest.classList.add('hidden'), 200));
    suggest.addEventListener('mousedown', function (e) {
      const li = e.target.closest('li[data-symbol]');
      if (li) {
        window.location.href = `stock.html?query=${encodeURIComponent(li.getAttribute('data-symbol'))}`;
      }
    });
    btn.onclick = function () {
      const keyword = input.value.trim();
      if (keyword) {
        window.location.href = `stock.html?query=${encodeURIComponent(keyword)}`;
      }
    };
    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        btn.click();
      }
    });
  </script>
  <div class="flex">
    <!-- 左侧导航栏（完全同步index.html结构） -->
    <aside id="sidebar"
      class="w-48 bg-white shadow min-h-screen p-3 flex flex-col items-center transition-all duration-300 hidden md:flex fixed top-16 left-0 z-40">
      <button id="sidebarToggle" class="mb-6 p-2 rounded hover:bg-blue-100 transition self-end"
        onclick="toggleSidebar()">
        <svg id="sidebarToggleIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none"
          viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 12H5" />
        </svg>
      </button>
      <nav class="space-y-4 flex flex-col items-center w-full mt-20">
        <a href="index.html"
          class="flex flex-col items-center justify-center px-2 py-2 rounded hover:bg-blue-50 transition text-gray-700 hover:text-blue-500 sidebar-link"
          data-i18n="dashboard">
          <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8v-10h-8v10zm0-18v6h8V3h-8z" />
          </svg>
          <span class="sidebar-text mt-1 text-center">Dashboard</span>
        </a>
        <a href="detail.html"
          class="flex flex-col items-center justify-center px-2 py-2 rounded hover:bg-blue-50 transition text-gray-700 hover:text-blue-500 sidebar-link"
          data-i18n="allocation">
          <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 2v10l6 6" />
          </svg>
          <span class="sidebar-text mt-1 text-center">Position Details</span>
        </a>
        <a href="management.html"
          class="flex flex-col items-center justify-center px-2 py-2 rounded hover:bg-blue-50 transition text-gray-700 hover:text-blue-500 sidebar-link"
          data-i18n="positions">
          <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <rect x="3" y="7" width="18" height="13" rx="2" />
            <path d="M16 3v4M8 3v4" />
          </svg>
          <span class="sidebar-text mt-1 text-center">Position Management</span>
        </a>
      </nav>
    </aside>
    <main id="mainContent" class="flex-1 p-8 pt-6 md:ml-48 transition-all duration-300">
      <div class="w-full max-w-6xl mx-auto">
        <!-- 股票标题和基本信息 -->
        <div
          class="mb-8 bg-gradient-to-r from-white via-blue-50 to-white rounded-3xl shadow-2xl border border-blue-100 overflow-hidden">
          <div class="p-8">
            <div class="text-center mb-6">
              <div
                class="text-4xl font-extrabold mb-2 bg-clip-text text-transparent bg-gradient-to-r from-blue-700 via-blue-500 to-cyan-500"
                id="stock-title">Loading...</div>
              <div id="stock-subtitle" class="text-gray-600 text-lg"></div>
            </div>

            <!-- 价格显示区域 -->
            <div id="price-section" class="bg-white/80 rounded-xl p-5 mb-5 shadow-md border border-blue-100">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div class="space-y-1">
                  <div class="text-xs text-gray-500 uppercase tracking-wide">Current Price</div>
                  <div id="current-price" class="text-2xl font-bold text-gray-800">--</div>
                </div>
                <div class="space-y-1">
                  <div class="text-xs text-gray-500 uppercase tracking-wide">Change</div>
                  <div id="price-change" class="text-xl font-semibold">--</div>
                </div>
                <div class="space-y-1">
                  <div class="text-xs text-gray-500 uppercase tracking-wide">Change %</div>
                  <div id="price-change-percent" class="text-xl font-semibold">--</div>
                </div>
              </div>
            </div>

            <!-- 详细信息网格 -->
            <div id="stock-meta" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 mb-5"></div>
          </div>
        </div>

        <!-- 图表区域 -->
        <div class="mb-6 bg-white rounded-2xl shadow-lg border border-blue-100 overflow-hidden">
          <div class="p-5">
            <div class="flex items-center justify-between mb-4">
              <h3 id="chart-title" class="text-lg font-semibold text-gray-800 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                  </path>
                </svg>
                1-Day Price Chart
              </h3>
              <div class="flex space-x-1">
                <button id="chart-1d"
                  class="chart-period-btn px-3 py-1 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600 transition font-medium active"
                  data-period="1d" data-interval="5min" data-size="78">1D</button>
                <button id="chart-1w"
                  class="chart-period-btn px-3 py-1 text-xs bg-gray-100 text-gray-600 rounded-md hover:bg-gray-200 transition"
                  data-period="1w" data-interval="1day" data-size="7">1W</button>
                <button id="chart-1m"
                  class="chart-period-btn px-3 py-1 text-xs bg-gray-100 text-gray-600 rounded-md hover:bg-gray-200 transition"
                  data-period="1m" data-interval="1day" data-size="30">1M</button>
                <button id="chart-1y"
                  class="chart-period-btn px-3 py-1 text-xs bg-gray-100 text-gray-600 rounded-md hover:bg-gray-200 transition"
                  data-period="1y" data-interval="1week" data-size="52">1Y</button>
              </div>
            </div>
            <div id="stock-chart" class="rounded-xl bg-white p-4 border border-gray-100 shadow-sm"
              style="height: 380px;">
              <div class="w-full h-full flex items-center justify-center text-gray-400">
                <svg class="animate-spin w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                  </path>
                </svg>
                Loading chart data...
              </div>
            </div>
          </div>
        </div>

        <!-- 操作按钮区域 -->
        <div class="bg-white rounded-2xl shadow-lg border border-blue-100 p-6">
          <div class="flex items-center justify-center gap-4">
            <button id="buyBtn"
              class="btn-hover-effect group relative px-8 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl text-base font-semibold shadow-md hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300 overflow-hidden">
              <span class="relative z-10 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6">
                  </path>
                </svg>
                BUY
              </span>
              <div
                class="absolute inset-0 bg-gradient-to-r from-green-600 to-emerald-700 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 origin-left">
              </div>
            </button>

            <button id="soldBtn"
              class="btn-hover-effect group relative px-8 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl text-base font-semibold shadow-md hover:shadow-lg transform hover:-translate-y-1 transition-all duration-300 overflow-hidden hidden">
              <span class="relative z-10 flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
                SOLD
              </span>
              <div
                class="absolute inset-0 bg-gradient-to-r from-red-600 to-red-700 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300 origin-left">
              </div>
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- 买入弹窗 -->
  <div id="buyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 transform transition-all duration-300 scale-95"
      id="buyModalContent">
      <div class="p-6">
        <div class="flex items-center mb-6">
          <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center mr-3">
            <i class="fas fa-plus text-green-500 text-lg"></i>
          </div>
          <h3 id="buyModalTitle" class="text-xl font-semibold text-gray-800">Buy Assets</h3>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Asset Code</label>
            <input type="text" id="buyModalTicker" readonly
              class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Asset Name <span
                class="text-gray-500 text-sm">(Leave it blank to obtain automatically)</span></label>
            <input type="text" id="buyModalName" placeholder="e.g.: Apple Inc. (can be left blank)"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Asset Type <span
                class="text-gray-500 text-sm">(Automatically detect, unless gold or currency is selected)</span></label>
            <select id="buyModalType"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="auto">Auto-Detect</option>
              <option value="stock">Stock</option>
              <option value="bond">Bond</option>
              <option value="fund">Fund</option>
              <option value="gold">Gold</option>
              <option value="currency">Currency</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Purchase Quantity</label>
            <input type="number" id="buyModalQuantity" placeholder="Enter quantity" min="1"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Purchase Price <span
                class="text-gray-500 text-sm">(Leave it blank to use the current market price)</span></label>
            <input type="number" id="buyModalPrice" placeholder="Enter price or leave blank" step="0.01" min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
          </div>
        </div>

        <div class="flex justify-end space-x-3 mt-8">
          <button onclick="closeBuyModal()"
            class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-lg font-medium transition duration-200">
            Cancel
          </button>
          <button onclick="confirmBuy()"
            class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium transition duration-200">
            Confirm Buy
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 卖出弹窗 -->
  <div id="sellModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 transform transition-all duration-300 scale-95"
      id="sellModalContent">
      <div class="p-6">
        <div class="flex items-center mb-6">
          <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mr-3">
            <i class="fas fa-minus text-red-500 text-lg"></i>
          </div>
          <h3 class="text-xl font-semibold text-gray-800">Sell Asset</h3>
        </div>

        <div class="space-y-4">
          <div class="bg-gray-50 p-4 rounded-lg">
            <p class="text-sm text-gray-600">Asset Code</p>
            <p id="sellModalTicker" class="text-lg font-semibold text-gray-800"></p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Sell Quantity</label>
            <input type="number" id="sellModalQuantity" placeholder="Enter quantity" min="1"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
            <p id="sellModalMaxQuantity" class="text-sm text-gray-500 mt-1"></p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Selling Price <span
                class="text-gray-500 text-sm">(Leave it blank to use the current market price)</span></label>
            <input type="number" id="sellModalPrice" placeholder="Enter price or leave blank" step="0.01" min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
          </div>
        </div>

        <div class="flex justify-end space-x-3 mt-8">
          <button onclick="closeSellModal()"
            class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-lg font-medium transition duration-200">
            Cancel
          </button>
          <button onclick="confirmSell()"
            class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition duration-200">
            Confirm Sell
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 登录状态检查（与index.html一致）
    function checkLoginStatus() {
      const isLoggedIn = localStorage.getItem('isLoggedIn');
      const userToken = localStorage.getItem('userToken');
      if (!isLoggedIn || !userToken) {
        window.location.href = 'log_in.html';
        return false;
      }
      updateUserArea();
      return true;
    }
    function updateUserArea() {
      const userAccount = localStorage.getItem('userAccount');
      const userArea = document.getElementById('userArea');
      if (userAccount) {
        userArea.innerHTML = `
          <div class="flex items-center space-x-3">
            <span class="text-gray-700 font-medium">${userAccount}</span>
            <button onclick="logout()" class="text-red-500 hover:text-red-600 text-sm font-medium bg-transparent px-3 py-1 rounded border border-red-300 hover:border-red-400 transition">Logout</button>
          </div>
        `;
      } else {
        userArea.innerHTML = `
          <a href="log_in.html" class="text-blue-500 hover:text-blue-600 text-lg font-bold bg-transparent px-4 py-2 rounded transition">Login</a>
        `;
      }
    }
    function logout() {
      localStorage.removeItem('isLoggedIn');
      localStorage.removeItem('userToken');
      localStorage.removeItem('userAccount');
      localStorage.removeItem('currentUserId'); // 同时清除用户ID
      window.location.href = 'log_in.html';
    }
    // 数据缓存机制
    const dataCache = {
      search: new Map(),
      quote: new Map(),
      timeSeries: new Map()
    };
    const CACHE_DURATION = 2 * 60 * 1000; // 2分钟缓存

    // 图表相关变量
    let currentChart = null;
    let currentPeriod = '1d';

    function getCachedData(type, key) {
      const cache = dataCache[type];
      const cached = cache.get(key);
      if (cached && (Date.now() - cached.timestamp) < CACHE_DURATION) {
        console.log(`Using cached ${type} data for ${key}`);
        return cached.data;
      }
      return null;
    }

    function setCachedData(type, key, data) {
      const cache = dataCache[type];
      cache.set(key, {
        data: data,
        timestamp: Date.now()
      });
    }

    // 时间段切换功能
    function switchChartPeriod(period, interval, size, title) {
      currentPeriod = period;

      // 更新按钮状态
      document.querySelectorAll('.chart-period-btn').forEach(btn => {
        btn.classList.remove('bg-blue-500', 'text-white', 'font-medium', 'active');
        btn.classList.add('bg-gray-100', 'text-gray-600');
      });

      const activeBtn = document.querySelector(`[data-period="${period}"]`);
      if (activeBtn) {
        activeBtn.classList.remove('bg-gray-100', 'text-gray-600');
        activeBtn.classList.add('bg-blue-500', 'text-white', 'font-medium', 'active');
      }

      // 更新标题
      document.getElementById('chart-title').innerHTML = `
        <svg class="w-5 h-5 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
        ${title}
      `;

      // 重新加载图表数据
      if (window.currentSymbol) {
        loadChartData(window.currentSymbol, interval, size);
      }
    }

    // 获取时间段标题
    function getPeriodTitle(period) {
      const titles = {
        '1d': '1-Day Price Chart',
        '1w': '1-Week Price Chart',
        '1m': '1-Month Price Chart',
        '1y': '1-Year Price Chart'
      };
      return titles[period] || 'Price Chart';
    }

    // 加载图表数据
    async function loadChartData(symbol, interval = '1day', outputsize = 90) {
      const cacheKey = `${symbol}_${interval}_${outputsize}`;
      let timeSeriesData = getCachedData('timeSeries', cacheKey);

      if (!timeSeriesData) {
        const kUrl = `https://api.twelvedata.com/time_series?symbol=${encodeURIComponent(symbol)}&interval=${interval}&outputsize=${outputsize}&apikey=30860e660a9e49b697b24a9bb38e8a58`;
        try {
          console.log('Fetching time series for:', symbol, 'Interval:', interval, 'Size:', outputsize);
          const res = await fetch(kUrl);
          timeSeriesData = await res.json();
          console.log('Time series response:', timeSeriesData);

          // 只缓存成功的响应
          if (!timeSeriesData.code && timeSeriesData.status === 'ok') {
            setCachedData('timeSeries', cacheKey, timeSeriesData);
          }
        } catch (e) {
          console.error('Time series fetch error:', e);
          document.getElementById('stock-chart').innerHTML = `
            <div class="w-full h-full flex flex-col items-center justify-center text-red-400">
              <svg class="w-12 h-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192L5.636 18.364M12 2.25a9.75 9.75 0 109.75 9.75A9.75 9.75 0 0012 2.25z"></path>
              </svg>
              <div class="text-center">
                <div class="font-medium">Network Error</div>
                <div class="text-sm mt-1">Unable to load chart data</div>
              </div>
            </div>
          `;
          return;
        }
      }

      if (timeSeriesData.code) {
        document.getElementById('stock-chart').innerHTML = `
          <div class="w-full h-full flex flex-col items-center justify-center text-red-400">
            <svg class="w-12 h-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div class="text-center">
              <div class="font-medium">Chart API Error</div>
              <div class="text-sm mt-1">${timeSeriesData.message || timeSeriesData.code}</div>
            </div>
          </div>
        `;
        console.error('Time series API Error:', timeSeriesData);
      } else if (timeSeriesData.status === 'ok' && timeSeriesData.values) {
        renderChart(timeSeriesData, interval);
      } else {
        document.getElementById('stock-chart').innerHTML = `
          <div class="w-full h-full flex flex-col items-center justify-center text-gray-400">
            <svg class="w-12 h-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            <div class="text-center">
              <div class="font-medium">No chart data available</div>
              <div class="text-sm mt-1">Historical data not found for this symbol</div>
            </div>
          </div>
        `;
      }
    }

    // 渲染图表
    function renderChart(timeSeriesData, interval) {
      const ctxId = 'stockKChart';
      document.getElementById('stock-chart').innerHTML = `<canvas id="${ctxId}" style="width: 100%; height: 100%;"></canvas>`;

      // 根据时间间隔格式化标签
      const labels = timeSeriesData.values.map(v => {
        const date = new Date(v.datetime);
        if (interval === '5min') {
          // 1D数据显示时间
          return date.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
          });
        } else if (interval === '1week') {
          // 1Y数据显示月日
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        } else {
          // 1W, 1M数据显示月日
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
      }).reverse();

      const prices = timeSeriesData.values.map(v => parseFloat(v.close)).reverse();

      // 销毁之前的图表
      if (currentChart) {
        currentChart.destroy();
      }

      currentChart = new Chart(document.getElementById(ctxId), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Close Price ($)',
            data: prices,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 3,
            pointHoverRadius: 6,
            pointBackgroundColor: '#3b82f6',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 20,
                font: {
                  size: 12,
                  weight: '500'
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#ffffff',
              bodyColor: '#ffffff',
              borderColor: '#3b82f6',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                title: function (context) {
                  return context[0].label;
                },
                label: function (context) {
                  return 'Price: $' + context.parsed.y.toFixed(2);
                }
              }
            }
          },
          scales: {
            x: {
              display: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)',
                drawBorder: false
              },
              ticks: {
                color: '#6b7280',
                font: {
                  size: 11
                },
                maxTicksLimit: interval === '5min' ? 12 : (interval === '1week' ? 10 : 8)
              }
            },
            y: {
              display: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)',
                drawBorder: false
              },
              ticks: {
                color: '#6b7280',
                font: {
                  size: 11
                },
                callback: function (value) {
                  return '$' + value.toFixed(2);
                }
              }
            }
          },
          elements: {
            point: {
              hoverBackgroundColor: '#3b82f6'
            }
          }
        }
      });
    }

    // API状态检查
    async function checkAPIStatus() {
      try {
        const testUrl = `https://api.twelvedata.com/quote?symbol=AAPL&apikey=30860e660a9e49b697b24a9bb38e8a58`;
        const response = await fetch(testUrl);
        const data = await response.json();

        if (data.code === 429) {
          document.getElementById('stock-title').innerHTML = `
            <div class="text-red-500 text-center">
              <div class="text-lg font-bold">API Rate Limit Exceeded</div>
              <div class="text-sm mt-2">Please wait a moment and try again. Free API has limited requests per minute.</div>
            </div>
          `;
          return false;
        } else if (data.code === 401) {
          document.getElementById('stock-title').innerHTML = `
            <div class="text-red-500 text-center">
              <div class="text-lg font-bold">API Key Invalid</div>
              <div class="text-sm mt-2">The API key may have expired or is invalid.</div>
            </div>
          `;
          return false;
        } else if (data.code) {
          console.warn('API Status Check:', data);
        }
        return true;
      } catch (error) {
        console.error('API Status Check Failed:', error);
        return true; // 继续尝试，可能是网络问题
      }
    }

    document.addEventListener('DOMContentLoaded', async function () {
      checkLoginStatus();

      // 添加时间段按钮事件监听器
      document.querySelectorAll('.chart-period-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const period = this.dataset.period;
          const interval = this.dataset.interval;
          const size = parseInt(this.dataset.size);
          const title = getPeriodTitle(period);

          switchChartPeriod(period, interval, size, title);
        });
      });

      // 检查API状态
      const apiOk = await checkAPIStatus();
      if (apiOk) {
        loadStockInfo();
      }
    });
    // 处理BUY/SOLD按钮状态
    async function updateBuySoldBtn(symbol) {
      try {
        const userId = getCurrentUserId();
        if (!userId) {
          // 未登录时使用原有逻辑
          const bought = localStorage.getItem('bought_' + symbol);
          document.getElementById('buyBtn').classList.remove('hidden');
          document.getElementById('soldBtn').classList.toggle('hidden', !bought);
          return;
        }

        // 获取用户持仓
        const holdings = await HoldingsAPI.getUserHoldings(userId);
        const holding = holdings.find(h => h.ticker === symbol);

        const buyBtn = document.getElementById('buyBtn');
        const soldBtn = document.getElementById('soldBtn');

        if (holding) {
          // 用户持有该股票 - 显示BUY和SOLD两个按钮
          buyBtn.classList.remove('hidden');
          soldBtn.classList.remove('hidden');

          // 更新按钮文本为简单的BUY和SOLD
          const buyBtnText = buyBtn.querySelector('span');
          const soldBtnText = soldBtn.querySelector('span');

          if (buyBtnText) {
            buyBtnText.innerHTML = `
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              BUY
            `;
          }

          if (soldBtnText) {
            soldBtnText.innerHTML = `
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
              </svg>
              SOLD
            `;
          }
        } else {
          // 用户未持有该股票 - 只显示BUY按钮
          buyBtn.classList.remove('hidden');
          soldBtn.classList.add('hidden');

          // 设置按钮文本为简单的BUY
          const buyBtnText = buyBtn.querySelector('span');
          if (buyBtnText) {
            buyBtnText.innerHTML = `
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              BUY
            `;
          }
        }

      } catch (error) {
        console.error('Failed to update buy/sell buttons:', error);
        // 出错时使用原有逻辑
        const bought = localStorage.getItem('bought_' + symbol);
        document.getElementById('buyBtn').classList.remove('hidden');
        document.getElementById('soldBtn').classList.toggle('hidden', !bought);
      }
    }
    document.getElementById('buyBtn').onclick = function () {
      const symbol = window.currentSymbol;
      if (!symbol) return;
      showBuyModal(symbol);
    };

    document.getElementById('soldBtn').onclick = async function () {
      const symbol = window.currentSymbol;
      if (!symbol) return;

      try {
        const userId = getCurrentUserId();
        if (!userId) {
          alert('Please log in first');
          return;
        }

        const holdings = await HoldingsAPI.getUserHoldings(userId);
        const holding = holdings.find(h => h.ticker === symbol);

        if (!holding) {
          alert('You do not hold this stock');
          return;
        }

        showSellModal(symbol, holding);

      } catch (error) {
        console.error('Failed to get holdings:', error);
        // 出错时使用原有逻辑
        localStorage.removeItem('bought_' + symbol);
        updateBuySoldBtn(symbol);
      }
    };

    // 获取当前用户ID
    function getCurrentUserId() {
      let userId = localStorage.getItem('currentUserId');
      if (!userId) {
        userId = '1'; // 默认用户ID
        localStorage.setItem('currentUserId', userId);
        console.log('Set the default user ID:', userId);
      }
      console.log('Current user ID:', userId);
      return userId;
    }

    // 弹窗相关函数
    function showBuyModal(symbol) {
      const modal = document.getElementById('buyModal');
      const content = document.getElementById('buyModalContent');

      document.getElementById('buyModalTicker').value = symbol;
      document.getElementById('buyModalName').value = '';
      document.getElementById('buyModalType').value = 'auto';
      document.getElementById('buyModalQuantity').value = '';
      document.getElementById('buyModalPrice').value = '';

      modal.classList.remove('hidden');
      setTimeout(() => {
        content.classList.add('scale-100');
        document.getElementById('buyModalQuantity').focus();
      }, 10);
    }

    function closeBuyModal() {
      const modal = document.getElementById('buyModal');
      const content = document.getElementById('buyModalContent');

      content.classList.remove('scale-100');
      setTimeout(() => modal.classList.add('hidden'), 300);
    }

    function showSellModal(symbol, holding) {
      const modal = document.getElementById('sellModal');
      const content = document.getElementById('sellModalContent');

      document.getElementById('sellModalTicker').textContent = symbol;
      document.getElementById('sellModalQuantity').value = '';
      document.getElementById('sellModalPrice').value = '';
      document.getElementById('sellModalQuantity').max = holding.quantity;
      document.getElementById('sellModalMaxQuantity').textContent = `Max Sellable: ${holding.quantity.toLocaleString()}`;

      modal.classList.remove('hidden');
      setTimeout(() => {
        content.classList.add('scale-100');
        document.getElementById('sellModalQuantity').focus();
      }, 10);
    }

    function closeSellModal() {
      const modal = document.getElementById('sellModal');
      const content = document.getElementById('sellModalContent');

      content.classList.remove('scale-100');
      setTimeout(() => modal.classList.add('hidden'), 300);
    }

    async function confirmBuy() {
      const symbol = document.getElementById('buyModalTicker').value;
      const name = document.getElementById('buyModalName').value.trim();
      const type = document.getElementById('buyModalType').value;
      const quantity = document.getElementById('buyModalQuantity').value;
      const price = document.getElementById('buyModalPrice').value;

      if (!quantity || isNaN(quantity) || parseFloat(quantity) <= 0) {
        alert('Please enter a valid purchase quantity');
        return;
      }

      if (price && (isNaN(price) || parseFloat(price) <= 0)) {
        alert('Please enter a valid price');
        return;
      }

      try {
        // 准备买入数据
        const buyData = {
          ticker: symbol,
          quantity: parseFloat(quantity)
        };

        // 添加可选字段
        if (price) buyData.price = parseFloat(price);
        if (name) buyData.name = name;
        if (type && type !== 'auto') buyData.type = type;

        await buyStock(symbol, quantity, price || null, type !== 'auto' ? type : null, name || null);
        closeBuyModal();
        updateBuySoldBtn(symbol);
        loadStockInfo();
      } catch (error) {
        console.error('Buy failed:', error);
      }
    }

    async function confirmSell() {
      const symbol = document.getElementById('sellModalTicker').value;
      const quantity = document.getElementById('sellModalQuantity').value;
      const price = document.getElementById('sellModalPrice').value;
      const maxQuantity = parseFloat(document.getElementById('sellModalQuantity').max);

      if (!quantity || isNaN(quantity) || parseFloat(quantity) <= 0) {
        alert('Please enter a valid sell quantity');
        return;
      }

      if (parseFloat(quantity) > maxQuantity) {
        alert(`Sell quantity cannot exceed holding quantity ${maxQuantity}`);
        return;
      }

      if (price && (isNaN(price) || parseFloat(price) <= 0)) {
        alert('Please enter a valid price');
        return;
      }

      try {
        await sellStock(symbol, quantity, price || null);
        closeSellModal();
        updateBuySoldBtn(symbol);
        loadStockInfo();
      } catch (error) {
        console.error('Sell failed:', error);
      }
    }

    // 点击弹窗外部关闭弹窗
    document.getElementById('buyModal').onclick = function (e) {
      if (e.target === this) {
        closeBuyModal();
      }
    };

    document.getElementById('sellModal').onclick = function (e) {
      if (e.target === this) {
        closeSellModal();
      }
    };

    // 键盘事件处理
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        if (!document.getElementById('buyModal').classList.contains('hidden')) {
          confirmBuy();
        } else if (!document.getElementById('sellModal').classList.contains('hidden')) {
          confirmSell();
        }
      } else if (e.key === 'Escape') {
        if (!document.getElementById('buyModal').classList.contains('hidden')) {
          closeBuyModal();
        } else if (!document.getElementById('sellModal').classList.contains('hidden')) {
          closeSellModal();
        }
      }
    });

    // 加载股票信息
    async function loadStockInfo() {
      const params = new URLSearchParams(window.location.search);
      const query = params.get('query');
      if (!query) {
        document.getElementById('stock-title').textContent = 'No stock selected.';
        return;
      }
      // 1. 搜索股票symbol (使用缓存)
      let symbol = '';
      let name = '';
      let data = getCachedData('search', query);

      if (!data) {
        const searchUrl = `https://api.twelvedata.com/symbol_search?symbol=${encodeURIComponent(query)}&apikey=30860e660a9e49b697b24a9bb38e8a58`;
        try {
          console.log('Searching for:', query, 'URL:', searchUrl);
          const res = await fetch(searchUrl);
          data = await res.json();
          console.log('Search response:', data);

          // 只缓存成功的响应
          if (!data.code) {
            setCachedData('search', query, data);
          }
        } catch (e) {
          console.error('Search API Error:', e);
          document.getElementById('stock-title').textContent = `Network Error: ${e.message}`;
          return;
        }
      }

      if (data.code) {
        console.error('API Error:', data);
        // 如果是配额限制，使用模拟数据
        if (data.code === 429) {
          console.log('Using demo data due to rate limit');
          symbol = query.toUpperCase();
          name = `${symbol} Inc.`;
        } else {
          document.getElementById('stock-title').textContent = `API Error: ${data.message || data.code}`;
          return;
        }
      }

      if (data.data && data.data.length > 0) {
        symbol = data.data[0].symbol;
        name = data.data[0].instrument_name || data.data[0].name || symbol;
      } else if (!symbol) { // 只有在没有从错误处理中设置symbol时才显示未找到
        document.getElementById('stock-title').textContent = 'Stock not found. Try: AAPL, MSFT, GOOGL';
        return;
      }
      window.currentSymbol = symbol;
      document.getElementById('stock-title').textContent = symbol;
      document.getElementById('stock-subtitle').textContent = name;
      // 2. 获取详细行情 (使用缓存)
      let quoteData = getCachedData('quote', symbol);

      if (!quoteData) {
        const quoteUrl = `https://api.twelvedata.com/quote?symbol=${encodeURIComponent(symbol)}&apikey=30860e660a9e49b697b24a9bb38e8a58`;
        try {
          console.log('Fetching quote for:', symbol, 'URL:', quoteUrl);
          const res = await fetch(quoteUrl);
          quoteData = await res.json();
          console.log('Quote response:', quoteData);

          // 只缓存成功的响应
          if (!quoteData.code && quoteData.status !== 'error') {
            setCachedData('quote', symbol, quoteData);
          }
        } catch (e) {
          console.error('Quote fetch error:', e);
          document.getElementById('stock-meta').innerHTML = `<span class="text-red-500 col-span-full text-center">Network Error: ${e.message}</span>`;
          return;
        }
      }

      if (quoteData.code || quoteData.status === 'error') {
        const errorMsg = quoteData.message || quoteData.code || 'Unknown error';
        document.getElementById('stock-meta').innerHTML = `<span class="text-red-500 col-span-full text-center">Quote API Error: ${errorMsg}</span>`;
        console.error('Quote API Error:', quoteData);
      } else {
        // 更新价格显示区域
        const currentPrice = parseFloat(quoteData.price || 0);
        const change = parseFloat(quoteData.change || 0);
        const changePercent = parseFloat(quoteData.percent_change || 0);

        const priceElement = document.getElementById('current-price');
        const oldPrice = parseFloat(priceElement.textContent.replace('$', '')) || 0;
        priceElement.textContent = `$${currentPrice.toFixed(2)}`;

        // 添加价格变化动画
        if (oldPrice !== 0 && oldPrice !== currentPrice) {
          priceElement.classList.remove('price-up', 'price-down');
          if (currentPrice > oldPrice) {
            priceElement.classList.add('price-up');
          } else {
            priceElement.classList.add('price-down');
          }
        }

        const changeColor = change >= 0 ? 'text-green-600' : 'text-red-600';
        const changeSign = change >= 0 ? '+' : '';
        document.getElementById('price-change').className = `text-2xl font-semibold ${changeColor}`;
        document.getElementById('price-change').textContent = `${changeSign}$${change.toFixed(2)}`;

        document.getElementById('price-change-percent').className = `text-2xl font-semibold ${changeColor}`;
        document.getElementById('price-change-percent').textContent = `${changeSign}${changePercent.toFixed(2)}%`;

        // 更新详细信息网格
        document.getElementById('stock-meta').innerHTML = `
            <div class='info-card bg-white/90 rounded-lg shadow-sm p-3 border border-blue-50'>
              <div class='text-xs text-gray-500 uppercase tracking-wide mb-1'>Exchange</div>
              <div class='font-semibold text-gray-800 text-sm'>${quoteData.exchange || '-'}</div>
            </div>
            <div class='info-card bg-white/90 rounded-lg shadow-sm p-3 border border-blue-50'>
              <div class='text-xs text-gray-500 uppercase tracking-wide mb-1'>Currency</div>
              <div class='font-semibold text-gray-800 text-sm'>${quoteData.currency || '-'}</div>
            </div>
            <div class='info-card bg-white/90 rounded-lg shadow-sm p-3 border border-blue-50'>
              <div class='text-xs text-gray-500 uppercase tracking-wide mb-1'>Open</div>
              <div class='font-semibold text-gray-800 text-sm'>$${parseFloat(quoteData.open || 0).toFixed(2)}</div>
            </div>
            <div class='info-card bg-white/90 rounded-lg shadow-sm p-3 border border-blue-50'>
              <div class='text-xs text-gray-500 uppercase tracking-wide mb-1'>High</div>
              <div class='font-semibold text-green-600 text-sm'>$${parseFloat(quoteData.high || 0).toFixed(2)}</div>
            </div>
            <div class='info-card bg-white/90 rounded-lg shadow-sm p-3 border border-blue-50'>
              <div class='text-xs text-gray-500 uppercase tracking-wide mb-1'>Low</div>
              <div class='font-semibold text-red-600 text-sm'>$${parseFloat(quoteData.low || 0).toFixed(2)}</div>
            </div>
            <div class='info-card bg-white/90 rounded-lg shadow-sm p-3 border border-blue-50'>
              <div class='text-xs text-gray-500 uppercase tracking-wide mb-1'>Volume</div>
              <div class='font-semibold text-gray-800 text-sm'>${quoteData.volume ? parseInt(quoteData.volume).toLocaleString() : '-'}</div>
            </div>
            <div class='info-card bg-white/90 rounded-lg shadow-sm p-3 border border-blue-50'>
              <div class='text-xs text-gray-500 uppercase tracking-wide mb-1'>Prev Close</div>
              <div class='font-semibold text-gray-800 text-sm'>$${parseFloat(quoteData.previous_close || 0).toFixed(2)}</div>
            </div>
            <div class='info-card bg-white/90 rounded-lg shadow-sm p-3 border border-blue-50'>
              <div class='text-xs text-gray-500 uppercase tracking-wide mb-1'>Avg Volume</div>
              <div class='font-semibold text-gray-800 text-sm'>${quoteData.average_volume ? parseInt(quoteData.average_volume).toLocaleString() : '-'}</div>
            </div>
          `;
      }
      // 3. 加载默认图表数据 (1天)
      const activeBtn = document.querySelector('.chart-period-btn.active') || document.querySelector('[data-period="1d"]');
      const interval = activeBtn ? activeBtn.dataset.interval : '5min';
      const size = activeBtn ? parseInt(activeBtn.dataset.size) : 78;

      loadChartData(symbol, interval, size);
      // 4. 按钮状态
      updateBuySoldBtn(symbol);
    }
    // 侧边栏收起/展开功能（与index.html一致）
    let sidebarCollapsed = false;
    function toggleSidebar() {
      sidebarCollapsed = !sidebarCollapsed;
      const sidebar = document.getElementById('sidebar');
      const main = document.getElementById('mainContent');
      const texts = sidebar.querySelectorAll('.sidebar-text');
      if (sidebarCollapsed) {
        sidebar.classList.remove('w-48');
        sidebar.classList.add('w-16');
        main.classList.remove('md:ml-48');
        main.classList.add('md:ml-16');
        texts.forEach(t => t.classList.add('hidden'));
        document.getElementById('sidebarToggleIcon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />';
      } else {
        sidebar.classList.remove('w-16');
        sidebar.classList.add('w-48');
        main.classList.remove('md:ml-16');
        main.classList.add('md:ml-48');
        texts.forEach(t => t.classList.remove('hidden'));
        document.getElementById('sidebarToggleIcon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 12H5" />';
      }
    }

    // API配置和工具函数
    const API_CONFIG = {
      BASE_URL: 'http://localhost:3000', // 后端服务器地址
      ENDPOINTS: {
        // 用户相关
        USERS: '/api/users',
        USER_BY_ID: (userId) => `/api/users/${userId}`,

        // 持仓相关
        HOLDINGS: (userId) => `/api/holdings/${userId}`,
        HOLDING_BY_ID: (userId, recordId) => `/api/holdings/${userId}/${recordId}`,
        BUY: (userId) => `/api/holdings/${userId}/buy`,
        SELL: (userId) => `/api/holdings/${userId}/sell`,

        // 股票数据
        STOCK_PRICE: (ticker) => `/api/stock/price/${ticker}`,
        STOCK_QUOTE: (ticker) => `/api/stock/quote/${ticker}`,

        // 缓存管理
        CACHE_REFRESH: (ticker) => `/api/cache/refresh/${ticker}`,
        CACHE_STATUS: '/api/cache/status'
      }
    };

    // API请求工具函数
    class APIClient {
      constructor() {
        this.baseURL = API_CONFIG.BASE_URL;
      }

      // 通用请求方法
      async request(endpoint, options = {}) {
        const url = `${this.baseURL}${endpoint}`;
        const config = {
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          ...options
        };

        console.log('API请求:', {
          url,
          method: config.method || 'GET',
          body: config.body
        });

        try {
          const response = await fetch(url, config);
          console.log('API响应状态:', response.status, response.statusText);

          let data;
          try {
            data = await response.json();
            console.log('API响应数据:', data);
          } catch (parseError) {
            console.error('JSON解析错误:', parseError);
            throw new Error('服务器返回了无效的JSON数据');
          }

          if (!response.ok) {
            const errorMessage = data.message || data.error || `HTTP error! status: ${response.status}`;
            console.error('API错误:', errorMessage);
            throw new Error(errorMessage);
          }

          return data;
        } catch (error) {
          console.error('API Request Error:', error);

          // 网络错误的特殊处理
          if (error.name === 'TypeError' && error.message.includes('fetch')) {
            throw new Error('无法连接到服务器，请检查后端是否启动 (http://localhost:3000)');
          }

          throw error;
        }
      }

      // GET请求
      async get(endpoint) {
        return this.request(endpoint, { method: 'GET' });
      }

      // POST请求
      async post(endpoint, data) {
        return this.request(endpoint, {
          method: 'POST',
          body: JSON.stringify(data)
        });
      }

      // PUT请求
      async put(endpoint, data) {
        return this.request(endpoint, {
          method: 'PUT',
          body: JSON.stringify(data)
        });
      }

      // DELETE请求
      async delete(endpoint) {
        return this.request(endpoint, { method: 'DELETE' });
      }
    }

    // 创建全局API客户端实例
    const apiClient = new APIClient();

    // 用户API
    const UserAPI = {
      // 获取所有用户
      async getAllUsers() {
        return apiClient.get(API_CONFIG.ENDPOINTS.USERS);
      },

      // 获取特定用户
      async getUserById(userId) {
        return apiClient.get(API_CONFIG.ENDPOINTS.USER_BY_ID(userId));
      },

      // 创建用户
      async createUser(userId, userData) {
        return apiClient.post(API_CONFIG.ENDPOINTS.USER_BY_ID(userId), userData);
      },

      // 更新用户
      async updateUser(userId, userData) {
        return apiClient.put(API_CONFIG.ENDPOINTS.USER_BY_ID(userId), userData);
      },

      // 删除用户
      async deleteUser(userId) {
        return apiClient.delete(API_CONFIG.ENDPOINTS.USER_BY_ID(userId));
      }
    };

    // 持仓API
    const HoldingsAPI = {
      // 获取用户持仓
      async getUserHoldings(userId) {
        return apiClient.get(API_CONFIG.ENDPOINTS.HOLDINGS(userId));
      },

      // 添加持仓
      async addHolding(userId, holdingData) {
        return apiClient.post(API_CONFIG.ENDPOINTS.HOLDINGS(userId), holdingData);
      },

      // 更新持仓
      async updateHolding(userId, recordId, holdingData) {
        return apiClient.put(API_CONFIG.ENDPOINTS.HOLDING_BY_ID(userId, recordId), holdingData);
      },

      // 删除持仓
      async deleteHolding(userId, recordId) {
        return apiClient.delete(API_CONFIG.ENDPOINTS.HOLDING_BY_ID(userId, recordId));
      },

      // 买入操作
      async buyStock(userId, buyData) {
        return apiClient.post(API_CONFIG.ENDPOINTS.BUY(userId), buyData);
      },

      // 卖出操作
      async sellStock(userId, sellData) {
        return apiClient.post(API_CONFIG.ENDPOINTS.SELL(userId), sellData);
      }
    };

    // 股票数据API
    const StockAPI = {
      // 获取股票价格
      async getStockPrice(ticker) {
        return apiClient.get(API_CONFIG.ENDPOINTS.STOCK_PRICE(ticker));
      },

      // 获取股票报价
      async getStockQuote(ticker) {
        return apiClient.get(API_CONFIG.ENDPOINTS.STOCK_QUOTE(ticker));
      }
    };

    // 缓存API
    const CacheAPI = {
      // 刷新缓存
      async refreshCache(ticker) {
        return apiClient.post(API_CONFIG.ENDPOINTS.CACHE_REFRESH(ticker));
      },

      // 获取缓存状态
      async getCacheStatus() {
        return apiClient.get(API_CONFIG.ENDPOINTS.CACHE_STATUS);
      }
    };

    // 导出API对象
    window.UserAPI = UserAPI;
    window.HoldingsAPI = HoldingsAPI;
    window.StockAPI = StockAPI;
    window.CacheAPI = CacheAPI;
    window.apiClient = apiClient;

    // 交易操作相关函数

    // 买入股票
    async function buyStock(ticker, quantity, price = null, type = null, name = null) {
      try {
        console.log('Start the buying operation:', { ticker, quantity, price, type, name });

        const userId = getCurrentUserId();
        if (!userId) {
          throw new Error('Please log in first');
        }
        console.log('Current user ID:', userId);

        // 准备买入数据
        const buyData = {
          ticker: ticker.toUpperCase(),
          quantity: parseFloat(quantity)
        };

        // 可选参数
        if (price !== null && price !== '') {
          buyData.price = parseFloat(price);
        }
        if (type) {
          buyData.type = type;
        }
        if (name) {
          buyData.name = name;
        }

        console.log('Buying data:', buyData);

        // 显示加载状态
        showLoadingMessage('Processing buy order...');

        // 调用买入API
        console.log('Calling API: /api/holdings/' + userId + '/buy');
        const result = await HoldingsAPI.buyStock(userId, buyData);
        console.log('API response:', result);

        // 显示成功消息
        showSuccessMessage(`Buying successful!${result.message || 'The operation is completed'}`);

        // 返回结果以便进一步处理
        return result;

      } catch (error) {
        console.error('Buy stock error:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          name: error.name
        });

        // 更详细的错误信息
        let errorMessage = 'Buying failed';
        if (error.message.includes('fetch')) {
          errorMessage += ': Unable to connect to the server, please check if the backend is running';
        } else if (error.message.includes('CORS')) {
          errorMessage += ': Cross-origin request blocked';
        } else if (error.message.includes('404')) {
          errorMessage += ': API endpoint not found';
        } else if (error.message.includes('500')) {
          errorMessage += ': Internal server error';
        } else {
          errorMessage += ': ' + error.message;
        }

        showErrorMessage(errorMessage);
        throw error;
      }
    }

    // 卖出股票
    async function sellStock(ticker, quantity, price = null) {
      try {
        const userId = getCurrentUserId();
        if (!userId) {
          throw new Error('Please log in first');
        }

        // 准备卖出数据
        const sellData = {
          ticker: ticker.toUpperCase(),
          quantity: parseFloat(quantity)
        };

        // 可选价格
        if (price !== null && price !== '') {
          sellData.price = parseFloat(price);
        }

        // 显示加载状态
        showLoadingMessage('Processing the sell order...');

        // 调用卖出API
        const result = await HoldingsAPI.sellStock(userId, sellData);

        // 显示成功消息
        showSuccessMessage(`Sold Successfully!${result.message}`);

        // 返回结果以便进一步处理
        return result;

      } catch (error) {
        console.error('Sell stock error:', error);
        showErrorMessage(`Sell Failed: ${error.message}`);
        throw error;
      }
    }

    // 获取股票当前价格
    async function getCurrentStockPrice(ticker) {
      try {
        const priceData = await StockAPI.getStockPrice(ticker);
        return parseFloat(priceData.price);
      } catch (error) {
        console.error('Get price error:', error);
        throw new Error(`无法获取 ${ticker} 的当前价格`);
      }
    }

    // 获取股票详细信息
    async function getStockInfo(ticker) {
      try {
        const quoteData = await StockAPI.getStockQuote(ticker);
        return {
          name: quoteData.name,
          price: parseFloat(quoteData.close || quoteData.price),
          change: quoteData.change,
          changePercent: quoteData.percent_change
        };
      } catch (error) {
        console.error('Get stock info error:', error);
        throw new Error(`Unable to obtain ${ticker} detailed information`);
      }
    }

    // 验证交易输入
    function validateTradeInput(ticker, quantity, price = null) {
      const errors = [];

      // 验证股票代码
      if (!ticker || ticker.trim() === '') {
        errors.push('Please enter the stock code');
      }

      // 验证数量
      if (!quantity || isNaN(quantity) || parseFloat(quantity) <= 0) {
        errors.push('Please enter a valid quantity (greater than 0)');
      }

      // 验证价格（如果提供）
      if (price !== null && price !== '' && (isNaN(price) || parseFloat(price) <= 0)) {
        errors.push('Please enter a valid price (greater than 0)');
      }

      return errors;
    }

    // 显示消息的工具函数
    function showLoadingMessage(message) {
      // 可以显示一个加载模态框或通知
      console.log('Loading:', message);
      // 实现具体的UI显示逻辑
    }

    function showSuccessMessage(message) {
      // 显示成功通知
      console.log('Success:', message);
      alert(message); // 简单实现，可以替换为更好的UI
    }

    function showErrorMessage(message) {
      // 显示错误通知
      console.error('Error:', message);
      alert(message); // 简单实现，可以替换为更好的UI
    }

    // 获取当前用户ID
    function getCurrentUserId() {
      return localStorage.getItem('currentUserId') || '1';
    }

    // 交易表单处理示例
    function setupTradingForm() {
      // 买入表单处理
      const buyForm = document.getElementById('buyForm');
      if (buyForm) {
        buyForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const ticker = document.getElementById('buyTicker').value;
          const quantity = document.getElementById('buyQuantity').value;
          const price = document.getElementById('buyPrice').value;

          // 验证输入
          const errors = validateTradeInput(ticker, quantity, price);
          if (errors.length > 0) {
            showErrorMessage(errors.join('\n'));
            return;
          }

          try {
            const result = await buyStock(ticker, quantity, price);
            // 清空表单
            buyForm.reset();
            // 刷新持仓数据
            if (typeof loadPortfolioData === 'function') {
              loadPortfolioData();
            }
          } catch (error) {
            // 错误已在buyStock函数中处理
          }
        });
      }

      // 卖出表单处理
      const sellForm = document.getElementById('sellForm');
      if (sellForm) {
        sellForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const ticker = document.getElementById('sellTicker').value;
          const quantity = document.getElementById('sellQuantity').value;
          const price = document.getElementById('sellPrice').value;

          // 验证输入
          const errors = validateTradeInput(ticker, quantity, price);
          if (errors.length > 0) {
            showErrorMessage(errors.join('\n'));
            return;
          }

          try {
            const result = await sellStock(ticker, quantity, price);
            // 清空表单
            sellForm.reset();
            // 刷新持仓数据
            if (typeof loadPortfolioData === 'function') {
              loadPortfolioData();
            }
          } catch (error) {
            // 错误已在sellStock函数中处理
          }
        });
      }
    }

    // 页面加载时设置表单
    document.addEventListener('DOMContentLoaded', setupTradingForm);

    // 导出函数供全局使用
    window.buyStock = buyStock;
    window.sellStock = sellStock;
    window.getCurrentStockPrice = getCurrentStockPrice;
    window.getStockInfo = getStockInfo;
    window.validateTradeInput = validateTradeInput;


    // 页面加载后初始化一次，防止刷新后状态不同步
    document.addEventListener('DOMContentLoaded', function () {
      const sidebar = document.getElementById('sidebar');
      const texts = sidebar.querySelectorAll('.sidebar-text');
      if (sidebarCollapsed) {
        texts.forEach(t => t.classList.add('hidden'));
      } else {
        texts.forEach(t => t.classList.remove('hidden'));
      }
    });
  </script>
</body>

</html>