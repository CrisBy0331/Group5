<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Position Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/api.js"></script>
    <style>
        /* ‰ª∑Ê†ºÊõ¥Êñ∞Âä®Áîª */
        .price-updated {
            animation: priceFlash 1s ease-in-out;
        }

        @keyframes priceFlash {
            0% {
                background-color: #fef3c7;
            }

            50% {
                background-color: #fbbf24;
            }

            100% {
                background-color: transparent;
            }
        }

        /* ÂÆûÊó∂ÊåáÁ§∫Âô®Âä®Áîª */
        .live-indicator {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Âç°ÁâáÊÇ¨ÂÅúÊïàÊûúÂ¢ûÂº∫ */
        .holding-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Ê∏êÂèòËÉåÊôØ */
        .gradient-bg {
            background: linear-gradient(135deg, #f6f9fc 0%, #e9f4ff 100%);
        }

        /* ËøáÊª§Âô®ÂÆπÂô®Ê†∑Âºè */
        .filter-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 text-gray-800 min-h-screen">
    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <header class="bg-white shadow h-16 px-6 flex justify-between items-center sticky top-0 z-50">
        <a href="index.html" class="flex items-center space-x-4 group cursor-pointer select-none">
            <svg class="w-9 h-9 text-blue-400 group-hover:text-blue-600 transition" fill="none" stroke="currentColor"
                stroke-width="2" viewBox="0 0 32 32">
                <circle cx="16" cy="16" r="13" stroke="currentColor" stroke-width="2" fill="#e0f2fe" />
                <path d="M10 20c2-4 10-4 12 0" stroke="#38bdf8" stroke-width="2" fill="none" />
                <path d="M16 10v8" stroke="#2563eb" stroke-width="2" stroke-linecap="round" />
                <circle cx="16" cy="10" r="2" fill="#2563eb" />
            </svg>
            <span
                class="text-2xl font-extrabold text-blue-400 group-hover:text-blue-600 tracking-wide transition leading-none"
                style="letter-spacing: 1px;">Future Assets</span>
        </a>
        <div class="flex items-center space-x-4">
            <div id="userArea"></div>
        </div>
    </header>

    <!-- È°µÈù¢‰∏ª‰ΩìÁªìÊûÑ -->
    <div class="flex">
        <!-- Â∑¶‰æßËæπÊ†è -->
        <aside id="sidebar"
            class="w-48 bg-white shadow min-h-screen p-3 flex flex-col items-center transition-all duration-300 hidden md:flex fixed top-16 left-0 z-40">
            <button id="sidebarToggle" class="mb-6 p-2 rounded hover:bg-blue-100 transition self-end"
                onclick="toggleSidebar()">
                <svg id="sidebarToggleIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 12H5" />
                </svg>
            </button>
            <nav class="space-y-4 flex flex-col items-center w-full mt-20">
                <a href="index.html"
                    class="flex flex-col items-center justify-center px-2 py-2 rounded hover:bg-blue-50 transition text-gray-700 hover:text-blue-500 sidebar-link"
                    data-i18n="dashboard">
                    <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2"
                        viewBox="0 0 24 24">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8v-10h-8v10zm0-18v6h8V3h-8z" />
                    </svg>
                    <span class="sidebar-text mt-1 text-center">Dashboard</span>
                </a>
                <a href="detail.html"
                    class="flex flex-col items-center justify-center px-2 py-2 rounded hover:bg-blue-50 transition text-blue-500 font-semibold sidebar-link"
                    data-i18n="allocation">
                    <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2"
                        viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" />
                        <path d="M12 2v10l6 6" />
                    </svg>
                    <span class="sidebar-text mt-1 text-center">Position Details</span>
                </a>
                <a href="management.html"
                    class="flex flex-col items-center justify-center px-2 py-2 rounded hover:bg-blue-50 transition text-gray-700 hover:text-blue-500 sidebar-link"
                    data-i18n="positions">
                    <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2"
                        viewBox="0 0 24 24">
                        <rect x="3" y="7" width="18" height="13" rx="2" />
                        <path d="M16 3v4M8 3v4" />
                    </svg>
                    <span class="sidebar-text mt-1 text-center">Position Management</span>
                </a>
            </nav>
        </aside>

        <!-- Âè≥‰æßÂÜÖÂÆπÂå∫Âüü -->
        <main id="mainContent" class="flex-1 p-6 pt-6 md:ml-48 transition-all duration-300">
            <h1 id="page-title" class="text-2xl font-bold text-gray-800 mb-6">Position Details</h1>
            <section id="portfolio-summary"
                class="bg-white p-5 rounded-lg shadow mb-6 flex flex-wrap gap-10 items-center shadow-lg">
                <div class="flex items-center gap-2">
                    <span class="text-gray-700 font-medium">Total Portfolio Value:</span>
                    <b id="totalPortfolioValue" class="text-xl font-bold text-gray-900">$100,000.00</b>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-700 font-medium">Total Profit:</span>
                    <b id="totalProfit" class="text-xl font-bold text-green-600">$3,500.00</b>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-700 font-medium">Total Profit Rate:</span>
                    <b id="totalProfitRate" class="text-xl font-bold text-gray-900">3.50%</b>
                </div>
            </section>
            <!-- ÂÆûÊó∂Êõ¥Êñ∞Áä∂ÊÄÅÊåáÁ§∫Âô® -->
            <div class="bg-white rounded-lg shadow-md p-3 mb-4 flex items-center justify-between">
                <div class="flex items-center">
                    <span class="w-3 h-3 bg-green-400 rounded-full mr-2 live-indicator"></span>
                    <span class="text-sm text-gray-600">Real-time updates every 15 seconds</span>
                </div>
                <div id="lastUpdateTime" class="text-xs text-gray-500">
                    Last updated: Loading...
                </div>
            </div>

            <!-- Âú® detail.html ÁöÑ <main> ‰∏≠Ê∑ªÂä†Á≠õÈÄâÂíåÊéíÂ∫èÂäüËÉΩ -->
            <section id="filter-sort-bar"
                class="bg-white p-4 mb-6 rounded-lg shadow-md flex flex-wrap gap-4 items-center">
                <!-- Á≠õÈÄâ‰∫ßÂìÅÁßçÁ±ª -->
                <label for="typeFilter" class="text-gray-700 font-medium">Product Type:</label>
                <select id="typeFilter"
                    class="px-4 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200">
                    <option value="all">All</option>
                    <option value="stock">Stock</option>
                    <option value="fund">Fund</option>
                    <option value="bond">Bond</option>
                    <option value="gold">Gold</option>
                    <option value="currency">Currency</option>
                </select>

                <!-- ÊéíÂ∫èÂ≠óÊÆµ -->
                <label for="sortField" class="text-gray-700 font-medium ml-4">Sort by:</label>
                <select id="sortField"
                    class="px-4 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200">
                    <option value="updated_at">Update Time</option>
                    <option value="totalValue">Total Value</option>
                    <option value="profitRate">Profit Rate</option>
                    <option value="quantity">Quantity</option>
                </select>

                <!-- ÊéíÂ∫èÈ°∫Â∫è -->
                <label for="sortOrder" class="text-gray-700 font-medium ml-4">Order:</label>
                <select id="sortOrder"
                    class="px-4 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200">
                    <option value="asc">Ascending</option>
                    <option value="desc" selected>Descending</option>
                </select>
            </section>

            <!-- Âç°ÁâáÂÆπÂô® -->
            <section id="holdings-list" class="space-y-4"></section>

            <script>
                
                const STOCK_API_CONFIG = {
                    // Alpha Vantage API 
                    ALPHA_VANTAGE: {
                        baseUrl: 'https://www.alphavantage.co/query',
                        apiKey: '30860e660a9e49b697b24a9bb38e8a58', // üîë ÊÇ®ÁöÑÊñ∞API Key
                        function: 'GLOBAL_QUOTE'
                    },
                    // Finnhub API 
                    FINNHUB: {
                        baseUrl: 'https://finnhub.io/api/v1',
                        apiKey: '30860e660a9e49b697b24a9bb38e8a58', 
                        endpoint: '/quote'
                    },
                    // Yahoo Finance API
                    YAHOO_FINANCE: {
                        baseUrl: 'https://query1.finance.yahoo.com/v8/finance/chart',
                        corsProxy: 'https://api.allorigins.win/raw?url='
                    }
                };
                const API_CONFIG = {
                    TWELVE_DATA: {
                        baseUrl: 'https://api.twelvedata.com',
                        apiKey: 'ece0e00571854b3fb054f32896a2ae82', 
                        endpoints: {
                            price: '/price', // Ëé∑ÂèñÊúÄÊñ∞‰ª∑Ê†º
                            timeSeries: '/time_series' // Ëé∑ÂèñÂéÜÂè≤Êó∂Èó¥Â∫èÂàóÊï∞ÊçÆ
                        }
                    }
                };

                // Áî®Êà∑Âå∫ÂüüÁõ∏ÂÖ≥ÂáΩÊï∞
                function checkLoginStatus() {
                    // ‰ªélocalStorageËé∑ÂèñÁôªÂΩïÁä∂ÊÄÅ
                    const isLoggedIn = localStorage.getItem('isLoggedIn');
                    const userToken = localStorage.getItem('userToken');

                    // Â¶ÇÊûúÊ≤°ÊúâÁôªÂΩïÁä∂ÊÄÅÊàñtokenÔºåË∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
                    if (!isLoggedIn || !userToken) {
                        window.location.href = 'log_in.html';
                        return false;
                    }

                    // Â¶ÇÊûúÂ∑≤ÁôªÂΩïÔºåÊõ¥Êñ∞Áî®Êà∑Âå∫ÂüüÊòæÁ§∫
                    updateUserArea();
                    return true;
                }

                // Êõ¥Êñ∞Áî®Êà∑Âå∫ÂüüÊòæÁ§∫
                function updateUserArea() {
                    const userAccount = localStorage.getItem('userAccount');
                    const userArea = document.getElementById('userArea');

                    if (userAccount) {
                        userArea.innerHTML = `
                            <div class="flex items-center space-x-3">
                                <span class="text-gray-700 font-medium">${userAccount}</span>
                                <button onclick="logout()"
                                    class="text-red-500 hover:text-red-600 text-sm font-medium bg-transparent px-3 py-1 rounded border border-red-300 hover:border-red-400 transition">
                                    Logout
                                </button>
                            </div>
                        `;
                    } else {
                        // Â¶ÇÊûúÊ≤°ÊúâÁôªÂΩï‰ø°ÊÅØÔºåÊòæÁ§∫ÁôªÂΩïÈìæÊé•
                        userArea.innerHTML = `
                            <a href="log_in.html" class="text-blue-500 hover:text-blue-600 text-lg font-bold bg-transparent px-4 py-2 rounded transition">
                                Login
                            </a>
                        `;
                    }
                }

                // ÁôªÂá∫ÂäüËÉΩ
                function logout() {
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('userToken');
                    localStorage.removeItem('userAccount');
                    localStorage.removeItem('currentUserId'); // ÂêåÊó∂Ê∏ÖÈô§Áî®Êà∑ID
                    window.location.href = 'log_in.html';
                }

                // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ID
                function getCurrentUserId() {
                    let userId = localStorage.getItem('currentUserId');
                    if (!userId) {
                        userId = '1'; // ÈªòËÆ§Áî®Êà∑ID
                        localStorage.setItem('currentUserId', userId);
                        console.log('ËÆæÁΩÆÈªòËÆ§Áî®Êà∑ID:', userId);
                    }
                    console.log('ÂΩìÂâçÁî®Êà∑ID:', userId);
                    return userId;
                }

                // Â§ñÈÉ®APIËÇ°Á•®‰ª∑Ê†ºËé∑ÂèñÂáΩÊï∞
                async function getExternalStockPrice(ticker) {
                    console.log(`üîç Fetching external price for ${ticker}...`);

                    // Â∞ùËØïÂ§ö‰∏™APIÊ∫êÔºåÊåâ‰ºòÂÖàÁ∫ßÈ°∫Â∫è
                    const apiSources = [
                        () => getYahooFinancePrice(ticker),
                        () => getFinnhubPrice(ticker),
                        () => getAlphaVantagePrice(ticker)
                    ];

                    for (const apiCall of apiSources) {
                        try {
                            const result = await apiCall();
                            if (result && result.price > 0) {
                                console.log(`‚úÖ Got price for ${ticker}:`, result);
                                return result;
                            }
                        } catch (error) {
                            console.warn(`‚ö†Ô∏è API call failed for ${ticker}:`, error.message);
                            continue;
                        }
                    }

                    // Â¶ÇÊûúÊâÄÊúâÂ§ñÈÉ®APIÈÉΩÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞ÂêéÁ´ØAPI
                    console.log(`üîÑ Falling back to backend API for ${ticker}`);
                    return getBackendStockPrice(ticker);
                }

                // Yahoo Finance API (ÈÄöËøáCORS‰ª£ÁêÜ)
                async function getYahooFinancePrice(ticker) {
                    const url = `${STOCK_API_CONFIG.YAHOO_FINANCE.corsProxy}${encodeURIComponent(STOCK_API_CONFIG.YAHOO_FINANCE.baseUrl + '/' + ticker)}`;

                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) throw new Error(`Yahoo Finance API error: ${response.status}`);

                    const data = await response.json();
                    const result = data.chart?.result?.[0];

                    if (!result) throw new Error('No data from Yahoo Finance');

                    const currentPrice = result.meta?.regularMarketPrice || result.meta?.previousClose;
                    const previousClose = result.meta?.previousClose || result.meta?.chartPreviousClose;

                    if (!currentPrice) throw new Error('No price data available');

                    const change = currentPrice - previousClose;
                    const changePercent = previousClose > 0 ? ((change / previousClose) * 100) : 0;

                    return {
                        price: currentPrice,
                        change: change,
                        changePercent: changePercent,
                        previousClose: previousClose,
                        source: 'Yahoo Finance'
                    };
                }

                // Finnhub API
                async function getFinnhubPrice(ticker) {
                    const url = `${STOCK_API_CONFIG.FINNHUB.baseUrl}${STOCK_API_CONFIG.FINNHUB.endpoint}?symbol=${ticker}&token=${STOCK_API_CONFIG.FINNHUB.apiKey}`;

                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Finnhub API error: ${response.status}`);

                    const data = await response.json();

                    if (!data.c) throw new Error('No current price from Finnhub');

                    const currentPrice = data.c; // current price
                    const previousClose = data.pc; // previous close
                    const change = currentPrice - previousClose;
                    const changePercent = previousClose > 0 ? ((change / previousClose) * 100) : 0;

                    return {
                        price: currentPrice,
                        change: change,
                        changePercent: changePercent,
                        previousClose: previousClose,
                        high: data.h, // day high
                        low: data.l,  // day low
                        open: data.o, // day open
                        source: 'Finnhub'
                    };
                }

                // Alpha Vantage API
                async function getAlphaVantagePrice(ticker) {
                    const url = `${STOCK_API_CONFIG.ALPHA_VANTAGE.baseUrl}?function=${STOCK_API_CONFIG.ALPHA_VANTAGE.function}&symbol=${ticker}&apikey=${STOCK_API_CONFIG.ALPHA_VANTAGE.apiKey}`;

                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Alpha Vantage API error: ${response.status}`);

                    const data = await response.json();
                    const quote = data['Global Quote'];

                    if (!quote) throw new Error('No quote data from Alpha Vantage');

                    const currentPrice = parseFloat(quote['05. price']);
                    const change = parseFloat(quote['09. change']);
                    const changePercent = parseFloat(quote['10. change percent'].replace('%', ''));
                    const previousClose = currentPrice - change;

                    return {
                        price: currentPrice,
                        change: change,
                        changePercent: changePercent,
                        previousClose: previousClose,
                        high: parseFloat(quote['03. high']),
                        low: parseFloat(quote['04. low']),
                        open: parseFloat(quote['02. open']),
                        source: 'Alpha Vantage'
                    };
                }

                // ÂêéÁ´ØAPI‰Ωú‰∏∫Â§áÁî®
                async function getBackendStockPrice(ticker) {
                    const response = await fetch(`http://localhost:3000/api/stock/price/${ticker}`);
                    if (!response.ok) throw new Error(`Backend API error: ${response.status}`);

                    const data = await response.json();
                    return {
                        price: parseFloat(data.price),
                        change: 0, // ÂêéÁ´ØAPIÂèØËÉΩÊ≤°ÊúâÊ∂®Ë∑åÊï∞ÊçÆ
                        changePercent: 0,
                        source: 'Backend'
                    };
                }

                const typeFilter = document.getElementById("typeFilter");
                const sortField = document.getElementById("sortField");
                const sortOrder = document.getElementById("sortOrder");
                let holdingsData = [];

                const totalPortfolioValueElement = document.getElementById("totalPortfolioValue");
                const totalProfitElement = document.getElementById("totalProfit");
                const totalProfitRateElement = document.getElementById("totalProfitRate"); // Êñ∞Â¢û

                // Êõ¥Êñ∞ÊäïËµÑÁªÑÂêàÊ¶ÇËßà
                function updatePortfolioSummary() {
                    let totalValue = 0;
                    let totalProfit = 0;
                    let totalCost = 0;

                    holdingsData.forEach(item => {
                        totalValue += item.totalValue;
                        totalProfit += item.profit;
                        totalCost += item.totalCost;
                    });

                    // ËÆ°ÁÆóÊÄªÊî∂ÁõäÁéá
                    let totalProfitRate = 0;
                    if (totalCost > 0) { // ÈÅøÂÖçÈô§‰ª•Èõ∂
                        totalProfitRate = (totalProfit / totalCost) * 100;
                    }

                    // Êõ¥Êñ∞ÊÄª‰ª∑ÂÄºÊòæÁ§∫
                    totalPortfolioValueElement.textContent = `$${totalValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                    // Êõ¥Êñ∞ÊÄªÂà©Ê∂¶ÊòæÁ§∫ÔºåÂπ∂Ê†πÊçÆÁõà‰∫èËÆæÁΩÆÈ¢úËâ≤
                    if (totalProfit >= 0) {
                        totalProfitElement.classList.remove('text-red-600');
                        totalProfitElement.classList.add('text-green-600');
                    } else {
                        totalProfitElement.classList.remove('text-green-600');
                        totalProfitElement.classList.add('text-red-600');
                    }
                    totalProfitElement.textContent = `$${totalProfit.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                    // *** Êñ∞Â¢ûÔºöÊõ¥Êñ∞ÊÄªÊî∂ÁõäÁéáÊòæÁ§∫ÔºåÂπ∂Ê†πÊçÆÁõà‰∫èËÆæÁΩÆÈ¢úËâ≤ ***
                    if (totalProfitRate >= 0) {
                        totalProfitRateElement.classList.remove('text-red-600');
                        totalProfitRateElement.classList.add('text-green-600');
                    } else {
                        totalProfitRateElement.classList.remove('text-green-600');
                        totalProfitRateElement.classList.add('text-red-600');
                    }
                    totalProfitRateElement.textContent = `${totalProfitRate.toFixed(2)}%`; // Ê†ºÂºèÂåñ‰∏∫‰∏§‰ΩçÂ∞èÊï∞Âπ∂Âä†‰∏äÁôæÂàÜÂè∑
                    // Â¶ÇÊûúÊÄªÊàêÊú¨‰∏∫0ÔºåÂèØ‰ª•ËÄÉËôëÊòæÁ§∫ "--" Êàñ "0.00%"
                    if (totalCost === 0) {
                        totalProfitRateElement.textContent = "--";
                        totalProfitRateElement.classList.remove('text-green-600', 'text-red-600'); // Ê∏ÖÈô§È¢úËâ≤
                        totalProfitRateElement.classList.add('text-gray-900'); // ËÆæ‰∏∫ÈªòËÆ§Ëâ≤
                    }
                }


                // ‰øÆÊîπ fetchHoldings ÂáΩÊï∞ÔºåÂú®Êï∞ÊçÆÂä†ËΩΩÂπ∂Â§ÑÁêÜÂÆåÊàêÂêéË∞ÉÁî® updatePortfolioSummary
                async function fetchHoldings(userId) {
                    const res = await fetch(`http://localhost:3000/api/holdings/${userId}`);
                    const data = await res.json();
                    const enriched = await Promise.all(data.map(async (item) => {
                        try {
                            // ‰ΩøÁî®Â§ñÈÉ®APIËé∑ÂèñÂÆûÊó∂‰ª∑Ê†ºÊï∞ÊçÆ
                            const priceData = await getExternalStockPrice(item.ticker);

                            const currentPrice = priceData.price || item.buyin_price;
                            const dayChange = priceData.change || 0;
                            const dayChangePercent = priceData.changePercent || 0;
                            const previousClose = priceData.previousClose || currentPrice;

                            const totalValue = item.quantity * currentPrice; // ÊÄªÂ∏ÇÂÄº
                            const totalCost = item.quantity * item.buyin_price; // ÊÄªÊàêÊú¨
                            const profit = totalValue - totalCost; // ÊÄªÁõà‰∫è
                            const profitRate = totalCost > 0 ? ((profit / totalCost) * 100) : 0; // Áõà‰∫èÁéá

                            return {
                                ...item,
                                currentPrice,
                                totalValue,
                                totalCost,
                                profit,
                                profitRate,
                                // Êñ∞Â¢ûÔºöÂΩìÊó•Ê∂®Ë∑åÊï∞ÊçÆ
                                dayChange,
                                dayChangePercent,
                                previousClose,
                                high: priceData.high,
                                low: priceData.low,
                                open: priceData.open,
                                dataSource: priceData.source
                            };
                        } catch (error) {
                            console.warn(`Failed to get external price for ${item.ticker}:`, error);
                            // ‰ΩøÁî®‰π∞ÂÖ•‰ª∑‰Ωú‰∏∫ÂΩìÂâç‰ª∑Ê†º
                            const currentPrice = item.buyin_price;
                            const totalValue = item.quantity * currentPrice;
                            const totalCost = item.quantity * item.buyin_price;
                            const profit = 0;
                            const profitRate = 0;

                            return {
                                ...item,
                                currentPrice,
                                totalValue,
                                totalCost,
                                profit,
                                profitRate,
                                dayChange: 0,
                                dayChangePercent: 0,
                                previousClose: currentPrice,
                                dataSource: 'Fallback'
                            };
                        }
                    }));
                    holdingsData = enriched; // Êõ¥Êñ∞ÂÖ®Â±ÄÁöÑ holdingsData ÂèòÈáè

                    updatePortfolioSummary(); // <--- Âú®ËøôÈáåË∞ÉÁî®Êñ∞ÂáΩÊï∞ÔºåÊõ¥Êñ∞Ê¶ÇËßàÊï∞ÊçÆ
                    applyFilters(); // Êé•ÁùÄË∞ÉÁî®Á≠õÈÄâÂíåÊéíÂ∫èÂáΩÊï∞ÔºåÊòæÁ§∫ÊåÅ‰ªìÂàóË°®
                    updateLastUpdateTime(); // ÂàùÂßãÂä†ËΩΩÊó∂Êõ¥Êñ∞Êó∂Èó¥Êà≥
                }

                function formatDate(timestamp) {
                    const date = new Date(timestamp);
                    return date.toLocaleString();
                }

                function renderHoldings(data) {
                    const container = document.getElementById("holdings-list");
                    container.innerHTML = "";
                    console.log("Ê≠£Âú®Ê∏≤ÊüìÁöÑÊåÅ‰ªìÊï∞ÊçÆ:", data);
                    data.forEach(item => {
                        // ‰ΩøÁî®Â∑≤ËÆ°ÁÆóÂ•ΩÁöÑÁõà‰∫èÁéáÔºåÂπ∂Ê∑ªÂä†È¢úËâ≤
                        const profitRateDisplay = item.profitRate.toFixed(2);
                        const profitRateColor = item.profitRate >= 0 ? 'text-green-600' : 'text-red-600';
                        const profitColor = item.profit >= 0 ? 'text-green-600' : 'text-red-600';
                        const profitSign = item.profit >= 0 ? '+' : '';
                        // ÂéüÊúâÁöÑÂç°ÁâáÂ∑¶ËæπÊ°ÜÈ¢úËâ≤
                        const borderColor = item.type === "stock" ? "border-green-500" :
                            item.type === "fund" ? "border-yellow-500" :
                                item.type === "bond" ? "border-blue-500" :
                                    item.type === "gold" ? "border-amber-500" : "border-gray-400";

                        // *** Êñ∞Â¢ûÔºöÊ†πÊçÆÁ±ªÂûãÂÆö‰πâ‰∏çÂêåÁöÑÈ¢úËâ≤Ê†áÁ≠æÁ±ª ***
                        let typeColorClass = '';
                        switch (item.type) {
                            case 'stock':
                                typeColorClass = 'bg-green-100 text-green-800'; // ËÇ°Á•®ÁªøËâ≤
                                break;
                            case 'fund':
                                typeColorClass = 'bg-yellow-100 text-yellow-800'; // Âü∫ÈáëÈªÑËâ≤
                                break;
                            case 'bond':
                                typeColorClass = 'bg-blue-100 text-blue-800'; // ÂÄ∫Âà∏ËìùËâ≤
                                break;
                            case 'gold':
                                typeColorClass = 'bg-amber-100 text-amber-800'; // ÈªÑÈáëÁê•ÁèÄËâ≤
                                break;
                            case 'currency':
                                typeColorClass = 'bg-purple-100 text-purple-800'; // Ë¥ßÂ∏ÅÁ¥´Ëâ≤
                                break;
                            default:
                                typeColorClass = 'bg-gray-100 text-gray-800'; // ÈªòËÆ§ÁÅ∞Ëâ≤
                        }

                        const html = `
            <div class="holding-card bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-xl transform hover:-translate-y-1 border-l-4 ${borderColor} w-full relative overflow-hidden" data-ticker="${item.ticker}">
                <!-- ËÉåÊôØË£ÖÈ•∞ -->
                <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-50 to-transparent rounded-full transform translate-x-16 -translate-y-16 opacity-50"></div>

                <!-- Â§¥ÈÉ®‰ø°ÊÅØ -->
                <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                    <div class="mb-2 md:mb-0 flex items-center gap-3">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 mb-1">${item.name}</h3>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-mono text-gray-600 bg-gray-100 px-2 py-1 rounded">${item.ticker}</span>
                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${typeColorClass}">${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 bg-gray-50 px-2 py-1 rounded">
                        <i class="fas fa-clock mr-1"></i>
                        Updated: ${formatDate(item.updated_at)}
                    </div>
                </div>

                <!-- ‰ª∑Ê†º‰ø°ÊÅØÂå∫Âüü -->
                <div class="relative z-10 bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg p-4 mb-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-3">
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">Buy Price</div>
                            <div class="text-lg font-bold text-gray-700">$${item.buyin_price.toFixed(2)}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1 flex items-center justify-center">
                                <span class="w-2 h-2 bg-green-400 rounded-full mr-1 live-indicator"></span>
                                Current Price
                            </div>
                            <div class="current-price text-lg font-bold text-blue-600 transition-all duration-300">$${item.currentPrice.toFixed(2)}</div>
                            <div class="text-xs mt-1 ${item.dayChangePercent >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${item.dayChangePercent >= 0 ? '+' : ''}${item.dayChange.toFixed(2)} (${item.dayChangePercent >= 0 ? '+' : ''}${item.dayChangePercent.toFixed(2)}%)
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">Quantity</div>
                            <div class="text-lg font-bold text-gray-700">${item.quantity.toLocaleString()}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">Total Value</div>
                            <div class="text-lg font-bold text-gray-900">$${item.totalValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                        </div>
                    </div>

                    <!-- Â∏ÇÂú∫Êï∞ÊçÆË°å -->
                    ${item.open || item.high || item.low ? `
                    <div class="border-t border-gray-200 pt-3">
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-xs text-gray-500 mb-1">Open</div>
                                <div class="text-sm font-semibold text-gray-600">$${(item.open || 0).toFixed(2)}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">High</div>
                                <div class="text-sm font-semibold text-green-600">$${(item.high || 0).toFixed(2)}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">Low</div>
                                <div class="text-sm font-semibold text-red-600">$${(item.low || 0).toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>

                <!-- Áõà‰∫è‰ø°ÊÅØÂå∫Âüü -->
                <div class="relative z-10 grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-white border border-gray-200 rounded-lg p-3 text-center">
                        <div class="text-xs text-gray-500 mb-1">Profit/Loss</div>
                        <div class="flex items-center justify-center">
                            <i class="fas fa-${item.profit >= 0 ? 'arrow-up' : 'arrow-down'} ${profitColor} mr-1 text-xs"></i>
                            <span class="${profitColor} font-bold text-lg">${profitSign}$${Math.abs(item.profit).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                        </div>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg p-3 text-center">
                        <div class="text-xs text-gray-500 mb-1">Profit Rate</div>
                        <div class="flex items-center justify-center">
                            <i class="fas fa-${item.profitRate >= 0 ? 'trending-up' : 'trending-down'} ${profitRateColor} mr-1 text-xs"></i>
                            <span class="${profitRateColor} font-bold text-lg">${profitSign}${profitRateDisplay}%</span>
                        </div>
                    </div>
                </div>

                <!-- ‰ª∑Ê†ºË∂ãÂäøÂõæÂå∫Âüü -->
                <div class="relative z-10 bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-semibold text-gray-700">Price Trend (7 Days)</h4>
                        <div class="text-xs text-gray-500">
                            <i class="fas fa-chart-line mr-1"></i>
                            Live Data
                        </div>
                    </div>
                    <div class="relative" style="height: 120px;">
                        <canvas id="chart-${item.ticker}" class="w-full h-full"></canvas>
                    </div>
                    <div class="text-xs text-gray-400 text-center mt-2">
                        Hover to see details
                    </div>
                </div>

                <!-- Êï∞ÊçÆÊ∫êÊåáÁ§∫Âô® -->
                <div class="relative z-10 flex justify-between items-center text-xs text-gray-400 mt-2">
                    <span>Data: ${item.dataSource || 'Unknown'}</span>
                    <span class="flex items-center">
                        <i class="fas fa-database mr-1"></i>
                        Real-time
                    </span>
                </div>
            </div>`;
                        container.innerHTML += html;
                    });

                    // ÂàùÂßãÂåñÊâÄÊúâÂõæË°®
                    setTimeout(() => {
                        initializeAllCharts(data);
                    }, 100);
                }

                // ÂõæË°®Áõ∏ÂÖ≥ÂáΩÊï∞
                const chartInstances = new Map(); // Â≠òÂÇ®ÂõæË°®ÂÆû‰æã

                // ÂàùÂßãÂåñÊâÄÊúâÂõæË°®
                async function initializeAllCharts(holdings) {
                    for (const holding of holdings) {
                        await initializeChart(holding.ticker);
                    }
                }

                // ÂàùÂßãÂåñÂçï‰∏™ÂõæË°®
                async function initializeChart(ticker) {
                    const canvas = document.getElementById(`chart-${ticker}`);
                    if (!canvas) {
                        console.warn(`Canvas not found for ${ticker}`);
                        return;
                    }

                    const ctx = canvas.getContext('2d');

                    // Â¶ÇÊûúÂõæË°®Â∑≤Â≠òÂú®ÔºåÂÖàÈîÄÊØÅ
                    if (chartInstances.has(ticker)) {
                        chartInstances.get(ticker).destroy();
                    }

                    try {
                        // Ëé∑ÂèñÂéÜÂè≤‰ª∑Ê†ºÊï∞ÊçÆ
                        const priceData = await fetchHistoricalData(ticker);

                        // ÂàõÂª∫ÂõæË°®
                        const chart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: priceData.labels,
                                datasets: [{
                                    label: `${ticker} Price`,
                                    data: priceData.prices,
                                    borderColor: priceData.trend === 'up' ? '#10b981' : '#ef4444',
                                    backgroundColor: priceData.trend === 'up' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 0,
                                    pointHoverRadius: 4,
                                    pointHoverBackgroundColor: priceData.trend === 'up' ? '#10b981' : '#ef4444',
                                    pointHoverBorderColor: '#ffffff',
                                    pointHoverBorderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false,
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        titleColor: '#ffffff',
                                        bodyColor: '#ffffff',
                                        borderColor: priceData.trend === 'up' ? '#10b981' : '#ef4444',
                                        borderWidth: 1,
                                        cornerRadius: 6,
                                        displayColors: false,
                                        callbacks: {
                                            title: function (context) {
                                                return context[0].label;
                                            },
                                            label: function (context) {
                                                return `$${context.parsed.y.toFixed(2)}`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        display: false,
                                        grid: {
                                            display: false
                                        }
                                    },
                                    y: {
                                        display: false,
                                        grid: {
                                            display: false
                                        }
                                    }
                                },
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                elements: {
                                    point: {
                                        hoverRadius: 6
                                    }
                                }
                            }
                        });

                        chartInstances.set(ticker, chart);
                    } catch (error) {
                        console.error(`Failed to initialize chart for ${ticker}:`, error);
                        // ÊòæÁ§∫ÈîôËØØÁä∂ÊÄÅ
                        canvas.style.display = 'none';
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'flex items-center justify-center h-full text-gray-400 text-sm';
                        errorDiv.innerHTML = '<i class="fas fa-chart-line mr-2"></i>Chart unavailable';
                        canvas.parentNode.appendChild(errorDiv);
                    }
                }

                // Ëé∑ÂèñÂéÜÂè≤‰ª∑Ê†ºÊï∞ÊçÆ
                // Ëé∑ÂèñÂéÜÂè≤‰ª∑Ê†ºÊï∞ÊçÆ (‰ΩøÁî® Twelve Data API)
                async function fetchHistoricalData(ticker) {
                    try {
                        const days = 7;
                        const twelveDataConfig = API_CONFIG.TWELVE_DATA;
                        const url = `${twelveDataConfig.baseUrl}${twelveDataConfig.endpoints.timeSeries}?symbol=${ticker}&interval=1day&outputsize=${days}&apikey=${twelveDataConfig.apiKey}`;

                        console.log(`üìà Fetching historical data for ${ticker} from Twelve Data:`, url);

                        const response = await fetch(url);
                        if (!response.ok) {
                            console.error(`Twelve Data Historical API error for ${ticker}: ${response.status} - ${response.statusText}`);
                            throw new Error(`Failed to fetch historical data from Twelve Data for ${ticker}`);
                        }

                        const data = await response.json();

                        if (data.status === 'error' || !data.values || data.values.length === 0) {
                            console.warn(`Twelve Data returned no historical data for ${ticker}:`, data.message || 'No values found');
                            throw new Error(data.message || 'No historical data found');
                        }

                        const labels = [];
                        const prices = [];

                        // Twelve Data ËøîÂõûÁöÑÊï∞ÊçÆÊòØÂÄíÂ∫èÁöÑ (ÊúÄÊñ∞Êó•ÊúüÂú®Ââç)ÔºåÊâÄ‰ª•ÈúÄË¶ÅÂèçËΩ¨
                        // ÊàñËÄÖÁõ¥Êé•‰ªéÂêéÂæÄÂâçÈÅçÂéÜÔºåÁ°Æ‰øùÂõæË°®ÊòæÁ§∫‰ªéÊóßÂà∞Êñ∞ÁöÑË∂ãÂäø
                        for (let i = data.values.length - 1; i >= 0; i--) {
                            const item = data.values[i];
                            labels.push(new Date(item.datetime).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                            prices.push(parseFloat(item.close));
                        }

                        // ËÆ°ÁÆóË∂ãÂäø (Ê†πÊçÆÁ¨¨‰∏Ä‰∏™ÂíåÊúÄÂêé‰∏Ä‰∏™‰ª∑Ê†º)
                        const firstPrice = prices[0];
                        const lastPrice = prices[prices.length - 1];
                        const trend = lastPrice >= firstPrice ? 'up' : 'down';

                        return {
                            labels,
                            prices,
                            trend
                        };

                    } catch (error) {
                        console.error(`‚ùå Error fetching historical data for ${ticker} from Twelve Data:`, error);
                        // Â¶ÇÊûúËé∑ÂèñÂ§±Ë¥•ÔºåËøîÂõûÈªòËÆ§Ê®°ÊãüÊï∞ÊçÆ‰Ωú‰∏∫ÂõûÈÄÄ
                        const labels = ['6d ago', '5d ago', '4d ago', '3d ago', '2d ago', '1d ago', 'Today'];
                        const prices = [100, 102, 98, 105, 103, 107, 105]; // ÈªòËÆ§Ê®°ÊãüÊï∞ÊçÆ
                        return {
                            labels,
                            prices,
                            trend: 'up'
                        };
                    }
                }

                // Êõ¥Êñ∞ÂõæË°®Êï∞ÊçÆ
                function updateChartsWithNewPrices(holdings) {
                    holdings.forEach(holding => {
                        const chart = chartInstances.get(holding.ticker);
                        if (chart && holding.priceChanged) {
                            // Êõ¥Êñ∞ÂõæË°®ÁöÑÊúÄÂêé‰∏Ä‰∏™Êï∞ÊçÆÁÇπ
                            const dataset = chart.data.datasets[0];
                            if (dataset.data.length > 0) {
                                dataset.data[dataset.data.length - 1] = holding.currentPrice;

                                // Êõ¥Êñ∞È¢úËâ≤Âü∫‰∫é‰ª∑Ê†ºÂèòÂåñ
                                const trend = holding.dayChangePercent >= 0 ? 'up' : 'down';
                                dataset.borderColor = trend === 'up' ? '#10b981' : '#ef4444';
                                dataset.backgroundColor = trend === 'up' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';

                                chart.update('none'); // Êó†Âä®ÁîªÊõ¥Êñ∞
                            }
                        }
                    });
                }

                // ÊóßÁöÑDOMContentLoaded‰∫ã‰ª∂ÁõëÂê¨Âô®Â∑≤ÁßªËá≥‰∏ãÊñπÁªü‰∏ÄÂ§ÑÁêÜ


                function applyFilters() {
                    const type = typeFilter.value;
                    const sortBy = sortField.value;
                    const order = sortOrder.value;
                    let filtered = [...holdingsData];

                    // Á≠õÈÄâ
                    if (type !== "all") {
                        filtered = filtered.filter(item => item.type === type);
                    }

                    // ÊéíÂ∫è
                    filtered.sort((a, b) => {
                        let valA, valB;

                        // Ê†πÊçÆ sortBy Â≠óÊÆµËé∑ÂèñÂÄº
                        if (sortBy === "profitRate") {
                            // ‰ΩøÁî®Â∑≤ËÆ°ÁÆóÂ•ΩÁöÑÁõà‰∫èÁéá
                            valA = a.profitRate;
                            valB = b.profitRate;
                        } else if (sortBy === "updated_at") {
                            // Â∞ÜÊó∂Èó¥Êà≥Â≠óÁ¨¶‰∏≤ËΩ¨Êç¢‰∏∫Êï∞Â≠óËøõË°åÊØîËæÉ
                            valA = new Date(a[sortBy]).getTime();
                            valB = new Date(b[sortBy]).getTime();
                        } else {
                            valA = a[sortBy];
                            valB = b[sortBy];
                        }

                        // Â§ÑÁêÜÈùûÊï∞Â≠óÂÄºÁöÑÊØîËæÉÔºàÂ¶ÇÊûú sortBy Â≠óÊÆµÊòØÂ≠óÁ¨¶‰∏≤Ôºå‰æãÂ¶Ç nameÔºâ
                        if (typeof valA === 'string' && typeof valB === 'string') {
                            return order === "asc" ? valA.localeCompare(valB) : valB.localeCompare(valA);
                        }

                        // Êï∞Â≠óÊØîËæÉ
                        return order === "asc" ? valA - valB : valB - valA;
                    });

                    renderHoldings(filtered);
                }

                // ‰æßËæπÊ†èÊî∂Ëµ∑/Â±ïÂºÄÂäüËÉΩ
                let sidebarCollapsed = false;
                function toggleSidebar() {
                    sidebarCollapsed = !sidebarCollapsed;
                    const sidebar = document.getElementById('sidebar');
                    const main = document.getElementById('mainContent');
                    const texts = sidebar.querySelectorAll('.sidebar-text');
                    if (sidebarCollapsed) {
                        sidebar.classList.remove('w-48');
                        sidebar.classList.add('w-16');
                        main.classList.remove('md:ml-48');
                        main.classList.add('md:ml-16');
                        texts.forEach(t => t.classList.add('hidden'));
                        document.getElementById('sidebarToggleIcon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />';
                    } else {
                        sidebar.classList.remove('w-16');
                        sidebar.classList.add('w-48');
                        main.classList.remove('md:ml-16');
                        main.classList.add('md:ml-48');
                        texts.forEach(t => t.classList.remove('hidden'));
                        document.getElementById('sidebarToggleIcon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 12H5" />';
                    }
                }

                // ÂÆûÊó∂Êõ¥Êñ∞‰ª∑Ê†ºÁöÑÂÆöÊó∂Âô®
                let priceUpdateInterval;

                document.addEventListener("DOMContentLoaded", function () {
                    // ÂÖàÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
                    checkLoginStatus();

                    // ‰ΩøÁî®Âä®ÊÄÅÁî®Êà∑ID
                    const userId = getCurrentUserId();
                    fetchHoldings(userId);

                    // Ê∑ªÂä†ËøáÊª§Âô®‰∫ã‰ª∂ÁõëÂê¨Âô®
                    typeFilter.addEventListener('change', applyFilters);
                    sortField.addEventListener('change', applyFilters);
                    sortOrder.addEventListener('change', applyFilters);

                    // ÂêØÂä®ÂÆûÊó∂‰ª∑Ê†ºÊõ¥Êñ∞ÔºàÊØè15ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°Ôºâ
                    startPriceUpdates(userId);
                });

                // ÂêØÂä®ÂÆûÊó∂‰ª∑Ê†ºÊõ¥Êñ∞
                function startPriceUpdates(userId) {
                    // Ê∏ÖÈô§Áé∞ÊúâÂÆöÊó∂Âô®
                    if (priceUpdateInterval) {
                        clearInterval(priceUpdateInterval);
                    }

                    // ÊØè15ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°‰ª∑Ê†º
                    priceUpdateInterval = setInterval(() => {
                        updatePricesOnly();
                    }, 15000);
                }

                // Âè™Êõ¥Êñ∞‰ª∑Ê†ºÔºå‰∏çÈáçÊñ∞Ê∏≤ÊüìÊï¥‰∏™ÂàóË°®
                async function updatePricesOnly() {
                    if (holdingsData.length === 0) return;

                    console.log('üîÑ Updating real-time prices...');

                    try {
                        let hasChanges = false;

                        // Êõ¥Êñ∞ÊØè‰∏™ÊåÅ‰ªìÁöÑ‰ª∑Ê†º
                        const updatedData = await Promise.all(holdingsData.map(async (item) => {
                            try {
                                // ‰ΩøÁî®Â§ñÈÉ®APIËé∑ÂèñÊúÄÊñ∞‰ª∑Ê†º
                                const priceData = await getExternalStockPrice(item.ticker);

                                let currentPrice = item.currentPrice;
                                let priceChanged = false;
                                let dayChange = item.dayChange || 0;
                                let dayChangePercent = item.dayChangePercent || 0;

                                if (priceData && priceData.price > 0) {
                                    const newPrice = priceData.price;
                                    if (Math.abs(newPrice - item.currentPrice) > 0.01) {
                                        currentPrice = newPrice;
                                        dayChange = priceData.change || 0;
                                        dayChangePercent = priceData.changePercent || 0;
                                        priceChanged = true;
                                        hasChanges = true;
                                    }
                                }

                                // ÈáçÊñ∞ËÆ°ÁÆóÁõ∏ÂÖ≥Êï∞ÂÄº
                                const totalValue = item.quantity * currentPrice;
                                const totalCost = item.quantity * item.buyin_price;
                                const profit = totalValue - totalCost;
                                const profitRate = totalCost > 0 ? ((profit / totalCost) * 100) : 0;

                                return {
                                    ...item,
                                    currentPrice,
                                    totalValue,
                                    profit,
                                    profitRate,
                                    dayChange,
                                    dayChangePercent,
                                    priceChanged,
                                    high: priceData?.high || item.high,
                                    low: priceData?.low || item.low,
                                    open: priceData?.open || item.open,
                                    dataSource: priceData?.source || item.dataSource
                                };
                            } catch (error) {
                                console.warn(`Failed to update external price for ${item.ticker}:`, error);
                                return { ...item, priceChanged: false }; // ‰øùÊåÅÂéüÊï∞ÊçÆ
                            }
                        }));

                        // Êõ¥Êñ∞ÂÖ®Â±ÄÊï∞ÊçÆ
                        holdingsData = updatedData;

                        // Â¶ÇÊûúÊúâ‰ª∑Ê†ºÂèòÂåñÔºåÊ∑ªÂä†Âä®ÁîªÊïàÊûú
                        if (hasChanges) {
                            // Êõ¥Êñ∞Ê¶ÇËßàÊï∞ÊçÆ
                            updatePortfolioSummary();

                            // ÈáçÊñ∞Â∫îÁî®ËøáÊª§Âô®ÂíåÊéíÂ∫è
                            applyFilters();

                            // Êõ¥Êñ∞ÂõæË°®Êï∞ÊçÆ
                            updateChartsWithNewPrices(updatedData);

                            // Ê∑ªÂä†‰ª∑Ê†ºÂèòÂåñÂä®Áîª
                            setTimeout(() => {
                                holdingsData.forEach(item => {
                                    if (item.priceChanged) {
                                        const priceElement = document.querySelector(`[data-ticker="${item.ticker}"] .current-price`);
                                        if (priceElement) {
                                            priceElement.classList.add('price-updated');
                                            setTimeout(() => {
                                                priceElement.classList.remove('price-updated');
                                            }, 1000);
                                        }
                                    }
                                });
                            }, 100);

                            console.log('‚úÖ Prices updated with changes detected');
                        } else {
                            console.log('üìä Prices checked - no changes detected');
                        }

                        // Êõ¥Êñ∞ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥
                        updateLastUpdateTime();
                    } catch (error) {
                        console.error('‚ùå Failed to update prices:', error);
                    }
                }

                // Êõ¥Êñ∞ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥
                function updateLastUpdateTime() {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString();
                    const lastUpdateElement = document.getElementById('lastUpdateTime');
                    if (lastUpdateElement) {
                        lastUpdateElement.textContent = `Last updated: ${timeString}`;
                    }
                }

                // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜÂÆöÊó∂Âô®ÂíåÂõæË°®
                window.addEventListener('beforeunload', function () {
                    if (priceUpdateInterval) {
                        clearInterval(priceUpdateInterval);
                    }

                    // Ê∏ÖÁêÜÊâÄÊúâÂõæË°®ÂÆû‰æã
                    chartInstances.forEach((chart, ticker) => {
                        chart.destroy();
                    });
                    chartInstances.clear();
                });
            </script>

</body>

</html>