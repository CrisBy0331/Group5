<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Position Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/api.js"></script>
    <style>
        /* ä»·æ ¼æ›´æ–°åŠ¨ç”» */
        .price-updated {
            animation: priceFlash 1s ease-in-out;
        }

        @keyframes priceFlash {
            0% { background-color: #fef3c7; }
            50% { background-color: #fbbf24; }
            100% { background-color: transparent; }
        }

        /* å®æ—¶æŒ‡ç¤ºå™¨åŠ¨ç”» */
        .live-indicator {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* å¡ç‰‡æ‚¬åœæ•ˆæœå¢å¼º */
        .holding-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* æ¸å˜èƒŒæ™¯ */
        .gradient-bg {
            background: linear-gradient(135deg, #f6f9fc 0%, #e9f4ff 100%);
        }

        /* è¿‡æ»¤å™¨å®¹å™¨æ ·å¼ */
        .filter-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 text-gray-800 min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-white shadow h-16 px-6 flex justify-between items-center sticky top-0 z-50">
        <a href="index.html" class="flex items-center space-x-4 group cursor-pointer select-none">
            <svg class="w-9 h-9 text-blue-400 group-hover:text-blue-600 transition" fill="none" stroke="currentColor"
                stroke-width="2" viewBox="0 0 32 32">
                <circle cx="16" cy="16" r="13" stroke="currentColor" stroke-width="2" fill="#e0f2fe" />
                <path d="M10 20c2-4 10-4 12 0" stroke="#38bdf8" stroke-width="2" fill="none" />
                <path d="M16 10v8" stroke="#2563eb" stroke-width="2" stroke-linecap="round" />
                <circle cx="16" cy="10" r="2" fill="#2563eb" />
            </svg>
            <span
                class="text-2xl font-extrabold text-blue-400 group-hover:text-blue-600 tracking-wide transition leading-none"
                style="letter-spacing: 1px;">Future Assets</span>
        </a>
        <div class="flex items-center space-x-4">
            <div id="userArea"></div>
        </div>
    </header>

    <!-- é¡µé¢ä¸»ä½“ç»“æ„ -->
    <div class="flex">
        <!-- å·¦ä¾§è¾¹æ  -->
        <aside id="sidebar"
            class="w-48 bg-white shadow min-h-screen p-3 flex flex-col items-center transition-all duration-300 hidden md:flex fixed top-16 left-0 z-40">
            <button id="sidebarToggle" class="mb-6 p-2 rounded hover:bg-blue-100 transition self-end"
                onclick="toggleSidebar()">
                <svg id="sidebarToggleIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 12H5" />
                </svg>
            </button>
            <nav class="space-y-4 flex flex-col items-center w-full mt-20">
                <a href="index.html"
                    class="flex flex-col items-center justify-center px-2 py-2 rounded hover:bg-blue-50 transition text-gray-700 hover:text-blue-500 sidebar-link"
                    data-i18n="dashboard">
                    <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2"
                        viewBox="0 0 24 24">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8v-10h-8v10zm0-18v6h8V3h-8z" />
                    </svg>
                    <span class="sidebar-text mt-1 text-center">Dashboard</span>
                </a>
                <a href="detail.html"
                    class="flex flex-col items-center justify-center px-2 py-2 rounded hover:bg-blue-50 transition text-blue-500 font-semibold sidebar-link"
                    data-i18n="allocation">
                    <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2"
                        viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" />
                        <path d="M12 2v10l6 6" />
                    </svg>
                    <span class="sidebar-text mt-1 text-center">Position Details</span>
                </a>
                <a href="management.html"
                    class="flex flex-col items-center justify-center px-2 py-2 rounded hover:bg-blue-50 transition text-gray-700 hover:text-blue-500 sidebar-link"
                    data-i18n="positions">
                    <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2"
                        viewBox="0 0 24 24">
                        <rect x="3" y="7" width="18" height="13" rx="2" />
                        <path d="M16 3v4M8 3v4" />
                    </svg>
                    <span class="sidebar-text mt-1 text-center">Position Management</span>
                </a>
            </nav>
        </aside>

        <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
        <main id="mainContent" class="flex-1 p-6 pt-6 md:ml-48 transition-all duration-300">
            <h1 id="page-title" class="text-2xl font-bold text-gray-800 mb-6">Position Details</h1>
            <section id="portfolio-summary"
                class="bg-white p-5 rounded-lg shadow mb-6 flex flex-wrap gap-10 items-center shadow-lg">
                <div class="flex items-center gap-2">
                    <span class="text-gray-700 font-medium">Total Portfolio Value:</span>
                    <b id="totalPortfolioValue" class="text-xl font-bold text-gray-900">$100,000.00</b>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-700 font-medium">Total Profit:</span>
                    <b id="totalProfit" class="text-xl font-bold text-green-600">$3,500.00</b>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-700 font-medium">Total Profit Rate:</span>
                    <b id="totalProfitRate" class="text-xl font-bold text-gray-900">3.50%</b>
                </div>
            </section>
            <!-- å®æ—¶æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨ -->
            <div class="bg-white rounded-lg shadow-md p-3 mb-4 flex items-center justify-between">
                <div class="flex items-center">
                    <span class="w-3 h-3 bg-green-400 rounded-full mr-2 live-indicator"></span>
                    <span class="text-sm text-gray-600">Real-time updates every 15 seconds</span>
                </div>
                <div id="lastUpdateTime" class="text-xs text-gray-500">
                    Last updated: Loading...
                </div>
            </div>

            <!-- åœ¨ detail.html çš„ <main> ä¸­æ·»åŠ ç­›é€‰å’Œæ’åºåŠŸèƒ½ -->
            <section id="filter-sort-bar"
                class="bg-white p-4 mb-6 rounded-lg shadow-md flex flex-wrap gap-4 items-center">
                <!-- ç­›é€‰äº§å“ç§ç±» -->
                <label for="typeFilter" class="text-gray-700 font-medium">Product Type:</label>
                <select id="typeFilter"
                    class="px-4 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200">
                    <option value="all">All</option>
                    <option value="stock">Stock</option>
                    <option value="fund">Fund</option>
                    <option value="bond">Bond</option>
                    <option value="gold">Gold</option>
                    <option value="currency">Currency</option>
                </select>

                <!-- æ’åºå­—æ®µ -->
                <label for="sortField" class="text-gray-700 font-medium ml-4">Sort by:</label>
                <select id="sortField"
                    class="px-4 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200">
                    <option value="updated_at">Update Time</option>
                    <option value="totalValue">Total Value</option>
                    <option value="profitRate">Profit Rate</option>
                    <option value="quantity">Quantity</option>
                </select>

                <!-- æ’åºé¡ºåº -->
                <label for="sortOrder" class="text-gray-700 font-medium ml-4">Order:</label>
                <select id="sortOrder"
                    class="px-4 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200">
                    <option value="asc">Ascending</option>
                    <option value="desc" selected>Descending</option>
                </select>
            </section>

            <!-- å¡ç‰‡å®¹å™¨ -->
            <section id="holdings-list" class="space-y-4"></section>

            <script>
                // å¤–éƒ¨è‚¡ç¥¨APIé…ç½®
                // ğŸ”§ é…ç½®è¯´æ˜ï¼š
                // 1. Alpha Vantage: å…è´¹æ³¨å†Œ https://www.alphavantage.co/support/#api-key
                // 2. Finnhub: å…è´¹æ³¨å†Œ https://finnhub.io/register
                // 3. Yahoo Finance: é€šè¿‡CORSä»£ç†è®¿é—®ï¼Œæ— éœ€API Key
                const STOCK_API_CONFIG = {
                    // Alpha Vantage API (å…è´¹ï¼Œéœ€è¦æ³¨å†Œè·å–API Key)
                    ALPHA_VANTAGE: {
                        baseUrl: 'https://www.alphavantage.co/query',
                        apiKey: '30860e660a9e49b697b24a9bb38e8a58', // ğŸ”‘ æ‚¨çš„æ–°API Key
                        function: 'GLOBAL_QUOTE'
                    },
                    // Finnhub API (å…è´¹å±‚çº§)
                    FINNHUB: {
                        baseUrl: 'https://finnhub.io/api/v1',
                        apiKey: '30860e660a9e49b697b24a9bb38e8a58', // ğŸ”‘ æ‚¨çš„æ–°API Key
                        endpoint: '/quote'
                    },
                    // Yahoo Finance API (é€šè¿‡ç¬¬ä¸‰æ–¹ä»£ç†)
                    YAHOO_FINANCE: {
                        baseUrl: 'https://query1.finance.yahoo.com/v8/finance/chart',
                        corsProxy: 'https://api.allorigins.win/raw?url='
                    }
                };

                // ç”¨æˆ·åŒºåŸŸç›¸å…³å‡½æ•° (ä¸index.htmlä¸€è‡´)
                function checkLoginStatus() {
                    // ä»localStorageè·å–ç™»å½•çŠ¶æ€
                    const isLoggedIn = localStorage.getItem('isLoggedIn');
                    const userToken = localStorage.getItem('userToken');

                    // å¦‚æœæ²¡æœ‰ç™»å½•çŠ¶æ€æˆ–tokenï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                    if (!isLoggedIn || !userToken) {
                        window.location.href = 'log_in.html';
                        return false;
                    }

                    // å¦‚æœå·²ç™»å½•ï¼Œæ›´æ–°ç”¨æˆ·åŒºåŸŸæ˜¾ç¤º
                    updateUserArea();
                    return true;
                }

                // æ›´æ–°ç”¨æˆ·åŒºåŸŸæ˜¾ç¤º
                function updateUserArea() {
                    const userAccount = localStorage.getItem('userAccount');
                    const userArea = document.getElementById('userArea');

                    if (userAccount) {
                        userArea.innerHTML = `
                            <div class="flex items-center space-x-3">
                                <span class="text-gray-700 font-medium">${userAccount}</span>
                                <button onclick="logout()"
                                    class="text-red-500 hover:text-red-600 text-sm font-medium bg-transparent px-3 py-1 rounded border border-red-300 hover:border-red-400 transition">
                                    Logout
                                </button>
                            </div>
                        `;
                    } else {
                        // å¦‚æœæ²¡æœ‰ç™»å½•ä¿¡æ¯ï¼Œæ˜¾ç¤ºç™»å½•é“¾æ¥
                        userArea.innerHTML = `
                            <a href="log_in.html" class="text-blue-500 hover:text-blue-600 text-lg font-bold bg-transparent px-4 py-2 rounded transition">
                                Login
                            </a>
                        `;
                    }
                }

                // ç™»å‡ºåŠŸèƒ½
                function logout() {
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('userToken');
                    localStorage.removeItem('userAccount');
                    localStorage.removeItem('currentUserId'); // åŒæ—¶æ¸…é™¤ç”¨æˆ·ID
                    window.location.href = 'log_in.html';
                }

                // è·å–å½“å‰ç”¨æˆ·ID
                function getCurrentUserId() {
                    let userId = localStorage.getItem('currentUserId');
                    if (!userId) {
                        userId = '1'; // é»˜è®¤ç”¨æˆ·ID
                        localStorage.setItem('currentUserId', userId);
                        console.log('è®¾ç½®é»˜è®¤ç”¨æˆ·ID:', userId);
                    }
                    console.log('å½“å‰ç”¨æˆ·ID:', userId);
                    return userId;
                }

                // å¤–éƒ¨APIè‚¡ç¥¨ä»·æ ¼è·å–å‡½æ•°
                async function getExternalStockPrice(ticker) {
                    console.log(`ğŸ” Fetching external price for ${ticker}...`);

                    // å°è¯•å¤šä¸ªAPIæºï¼ŒæŒ‰ä¼˜å…ˆçº§é¡ºåº
                    const apiSources = [
                        () => getYahooFinancePrice(ticker),
                        () => getFinnhubPrice(ticker),
                        () => getAlphaVantagePrice(ticker)
                    ];

                    for (const apiCall of apiSources) {
                        try {
                            const result = await apiCall();
                            if (result && result.price > 0) {
                                console.log(`âœ… Got price for ${ticker}:`, result);
                                return result;
                            }
                        } catch (error) {
                            console.warn(`âš ï¸ API call failed for ${ticker}:`, error.message);
                            continue;
                        }
                    }

                    // å¦‚æœæ‰€æœ‰å¤–éƒ¨APIéƒ½å¤±è´¥ï¼Œå›é€€åˆ°åç«¯API
                    console.log(`ğŸ”„ Falling back to backend API for ${ticker}`);
                    return getBackendStockPrice(ticker);
                }

                // Yahoo Finance API (é€šè¿‡CORSä»£ç†)
                async function getYahooFinancePrice(ticker) {
                    const url = `${STOCK_API_CONFIG.YAHOO_FINANCE.corsProxy}${encodeURIComponent(STOCK_API_CONFIG.YAHOO_FINANCE.baseUrl + '/' + ticker)}`;

                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) throw new Error(`Yahoo Finance API error: ${response.status}`);

                    const data = await response.json();
                    const result = data.chart?.result?.[0];

                    if (!result) throw new Error('No data from Yahoo Finance');

                    const currentPrice = result.meta?.regularMarketPrice || result.meta?.previousClose;
                    const previousClose = result.meta?.previousClose || result.meta?.chartPreviousClose;

                    if (!currentPrice) throw new Error('No price data available');

                    const change = currentPrice - previousClose;
                    const changePercent = previousClose > 0 ? ((change / previousClose) * 100) : 0;

                    return {
                        price: currentPrice,
                        change: change,
                        changePercent: changePercent,
                        previousClose: previousClose,
                        source: 'Yahoo Finance'
                    };
                }

                // Finnhub API
                async function getFinnhubPrice(ticker) {
                    const url = `${STOCK_API_CONFIG.FINNHUB.baseUrl}${STOCK_API_CONFIG.FINNHUB.endpoint}?symbol=${ticker}&token=${STOCK_API_CONFIG.FINNHUB.apiKey}`;

                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Finnhub API error: ${response.status}`);

                    const data = await response.json();

                    if (!data.c) throw new Error('No current price from Finnhub');

                    const currentPrice = data.c; // current price
                    const previousClose = data.pc; // previous close
                    const change = currentPrice - previousClose;
                    const changePercent = previousClose > 0 ? ((change / previousClose) * 100) : 0;

                    return {
                        price: currentPrice,
                        change: change,
                        changePercent: changePercent,
                        previousClose: previousClose,
                        high: data.h, // day high
                        low: data.l,  // day low
                        open: data.o, // day open
                        source: 'Finnhub'
                    };
                }

                // Alpha Vantage API
                async function getAlphaVantagePrice(ticker) {
                    const url = `${STOCK_API_CONFIG.ALPHA_VANTAGE.baseUrl}?function=${STOCK_API_CONFIG.ALPHA_VANTAGE.function}&symbol=${ticker}&apikey=${STOCK_API_CONFIG.ALPHA_VANTAGE.apiKey}`;

                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Alpha Vantage API error: ${response.status}`);

                    const data = await response.json();
                    const quote = data['Global Quote'];

                    if (!quote) throw new Error('No quote data from Alpha Vantage');

                    const currentPrice = parseFloat(quote['05. price']);
                    const change = parseFloat(quote['09. change']);
                    const changePercent = parseFloat(quote['10. change percent'].replace('%', ''));
                    const previousClose = currentPrice - change;

                    return {
                        price: currentPrice,
                        change: change,
                        changePercent: changePercent,
                        previousClose: previousClose,
                        high: parseFloat(quote['03. high']),
                        low: parseFloat(quote['04. low']),
                        open: parseFloat(quote['02. open']),
                        source: 'Alpha Vantage'
                    };
                }

                // åç«¯APIä½œä¸ºå¤‡ç”¨
                async function getBackendStockPrice(ticker) {
                    const response = await fetch(`http://localhost:3000/api/stock/price/${ticker}`);
                    if (!response.ok) throw new Error(`Backend API error: ${response.status}`);

                    const data = await response.json();
                    return {
                        price: parseFloat(data.price),
                        change: 0, // åç«¯APIå¯èƒ½æ²¡æœ‰æ¶¨è·Œæ•°æ®
                        changePercent: 0,
                        source: 'Backend'
                    };
                }

                const typeFilter = document.getElementById("typeFilter");
                const sortField = document.getElementById("sortField");
                const sortOrder = document.getElementById("sortOrder");
                let holdingsData = [];

                const totalPortfolioValueElement = document.getElementById("totalPortfolioValue");
                const totalProfitElement = document.getElementById("totalProfit");
                const totalProfitRateElement = document.getElementById("totalProfitRate"); // æ–°å¢

                // æ›´æ–°æŠ•èµ„ç»„åˆæ¦‚è§ˆ
                function updatePortfolioSummary() {
                    let totalValue = 0;
                    let totalProfit = 0;
                    let totalCost = 0;

                    holdingsData.forEach(item => {
                        totalValue += item.totalValue;
                        totalProfit += item.profit;
                        totalCost += item.totalCost;
                    });

                    // è®¡ç®—æ€»æ”¶ç›Šç‡
                    let totalProfitRate = 0;
                    if (totalCost > 0) { // é¿å…é™¤ä»¥é›¶
                        totalProfitRate = (totalProfit / totalCost) * 100;
                    }

                    // æ›´æ–°æ€»ä»·å€¼æ˜¾ç¤º
                    totalPortfolioValueElement.textContent = `$${totalValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                    // æ›´æ–°æ€»åˆ©æ¶¦æ˜¾ç¤ºï¼Œå¹¶æ ¹æ®ç›ˆäºè®¾ç½®é¢œè‰²
                    if (totalProfit >= 0) {
                        totalProfitElement.classList.remove('text-red-600');
                        totalProfitElement.classList.add('text-green-600');
                    } else {
                        totalProfitElement.classList.remove('text-green-600');
                        totalProfitElement.classList.add('text-red-600');
                    }
                    totalProfitElement.textContent = `$${totalProfit.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                    // *** æ–°å¢ï¼šæ›´æ–°æ€»æ”¶ç›Šç‡æ˜¾ç¤ºï¼Œå¹¶æ ¹æ®ç›ˆäºè®¾ç½®é¢œè‰² ***
                    if (totalProfitRate >= 0) {
                        totalProfitRateElement.classList.remove('text-red-600');
                        totalProfitRateElement.classList.add('text-green-600');
                    } else {
                        totalProfitRateElement.classList.remove('text-green-600');
                        totalProfitRateElement.classList.add('text-red-600');
                    }
                    totalProfitRateElement.textContent = `${totalProfitRate.toFixed(2)}%`; // æ ¼å¼åŒ–ä¸ºä¸¤ä½å°æ•°å¹¶åŠ ä¸Šç™¾åˆ†å·
                    // å¦‚æœæ€»æˆæœ¬ä¸º0ï¼Œå¯ä»¥è€ƒè™‘æ˜¾ç¤º "--" æˆ– "0.00%"
                    if (totalCost === 0) {
                        totalProfitRateElement.textContent = "--";
                        totalProfitRateElement.classList.remove('text-green-600', 'text-red-600'); // æ¸…é™¤é¢œè‰²
                        totalProfitRateElement.classList.add('text-gray-900'); // è®¾ä¸ºé»˜è®¤è‰²
                    }
                }


                // ä¿®æ”¹ fetchHoldings å‡½æ•°ï¼Œåœ¨æ•°æ®åŠ è½½å¹¶å¤„ç†å®Œæˆåè°ƒç”¨ updatePortfolioSummary
                async function fetchHoldings(userId) {
                    const res = await fetch(`http://localhost:3000/api/holdings/${userId}`);
                    const data = await res.json();
                    const enriched = await Promise.all(data.map(async (item) => {
                        try {
                            // ä½¿ç”¨å¤–éƒ¨APIè·å–å®æ—¶ä»·æ ¼æ•°æ®
                            const priceData = await getExternalStockPrice(item.ticker);

                            const currentPrice = priceData.price || item.buyin_price;
                            const dayChange = priceData.change || 0;
                            const dayChangePercent = priceData.changePercent || 0;
                            const previousClose = priceData.previousClose || currentPrice;

                            const totalValue = item.quantity * currentPrice; // æ€»å¸‚å€¼
                            const totalCost = item.quantity * item.buyin_price; // æ€»æˆæœ¬
                            const profit = totalValue - totalCost; // æ€»ç›ˆäº
                            const profitRate = totalCost > 0 ? ((profit / totalCost) * 100) : 0; // ç›ˆäºç‡

                            return {
                                ...item,
                                currentPrice,
                                totalValue,
                                totalCost,
                                profit,
                                profitRate,
                                // æ–°å¢ï¼šå½“æ—¥æ¶¨è·Œæ•°æ®
                                dayChange,
                                dayChangePercent,
                                previousClose,
                                high: priceData.high,
                                low: priceData.low,
                                open: priceData.open,
                                dataSource: priceData.source
                            };
                        } catch (error) {
                            console.warn(`Failed to get external price for ${item.ticker}:`, error);
                            // ä½¿ç”¨ä¹°å…¥ä»·ä½œä¸ºå½“å‰ä»·æ ¼
                            const currentPrice = item.buyin_price;
                            const totalValue = item.quantity * currentPrice;
                            const totalCost = item.quantity * item.buyin_price;
                            const profit = 0;
                            const profitRate = 0;

                            return {
                                ...item,
                                currentPrice,
                                totalValue,
                                totalCost,
                                profit,
                                profitRate,
                                dayChange: 0,
                                dayChangePercent: 0,
                                previousClose: currentPrice,
                                dataSource: 'Fallback'
                            };
                        }
                    }));
                    holdingsData = enriched; // æ›´æ–°å…¨å±€çš„ holdingsData å˜é‡

                    updatePortfolioSummary(); // <--- åœ¨è¿™é‡Œè°ƒç”¨æ–°å‡½æ•°ï¼Œæ›´æ–°æ¦‚è§ˆæ•°æ®
                    applyFilters(); // æ¥ç€è°ƒç”¨ç­›é€‰å’Œæ’åºå‡½æ•°ï¼Œæ˜¾ç¤ºæŒä»“åˆ—è¡¨
                    updateLastUpdateTime(); // åˆå§‹åŠ è½½æ—¶æ›´æ–°æ—¶é—´æˆ³
                }

                function formatDate(timestamp) {
                    const date = new Date(timestamp);
                    return date.toLocaleString();
                }

                function renderHoldings(data) {
                    const container = document.getElementById("holdings-list");
                    container.innerHTML = "";
                    console.log("æ­£åœ¨æ¸²æŸ“çš„æŒä»“æ•°æ®:", data);
                    data.forEach(item => {
                        // ä½¿ç”¨å·²è®¡ç®—å¥½çš„ç›ˆäºç‡ï¼Œå¹¶æ·»åŠ é¢œè‰²
                        const profitRateDisplay = item.profitRate.toFixed(2);
                        const profitRateColor = item.profitRate >= 0 ? 'text-green-600' : 'text-red-600';
                        const profitColor = item.profit >= 0 ? 'text-green-600' : 'text-red-600';
                        const profitSign = item.profit >= 0 ? '+' : '';
                        // åŸæœ‰çš„å¡ç‰‡å·¦è¾¹æ¡†é¢œè‰²
                        const borderColor = item.type === "stock" ? "border-green-500" :
                            item.type === "fund" ? "border-yellow-500" :
                                item.type === "bond" ? "border-blue-500" :
                                    item.type === "gold" ? "border-amber-500" : "border-gray-400";

                        // *** æ–°å¢ï¼šæ ¹æ®ç±»å‹å®šä¹‰ä¸åŒçš„é¢œè‰²æ ‡ç­¾ç±» ***
                        let typeColorClass = '';
                        switch (item.type) {
                            case 'stock':
                                typeColorClass = 'bg-green-100 text-green-800'; // è‚¡ç¥¨ç»¿è‰²
                                break;
                            case 'fund':
                                typeColorClass = 'bg-yellow-100 text-yellow-800'; // åŸºé‡‘é»„è‰²
                                break;
                            case 'bond':
                                typeColorClass = 'bg-blue-100 text-blue-800'; // å€ºåˆ¸è“è‰²
                                break;
                            case 'gold':
                                typeColorClass = 'bg-amber-100 text-amber-800'; // é»„é‡‘ç¥ç€è‰²
                                break;
                            case 'currency':
                                typeColorClass = 'bg-purple-100 text-purple-800'; // è´§å¸ç´«è‰²
                                break;
                            default:
                                typeColorClass = 'bg-gray-100 text-gray-800'; // é»˜è®¤ç°è‰²
                        }

                        const html = `
            <div class="holding-card bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-xl transform hover:-translate-y-1 border-l-4 ${borderColor} w-full relative overflow-hidden" data-ticker="${item.ticker}">
                <!-- èƒŒæ™¯è£…é¥° -->
                <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-50 to-transparent rounded-full transform translate-x-16 -translate-y-16 opacity-50"></div>

                <!-- å¤´éƒ¨ä¿¡æ¯ -->
                <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                    <div class="mb-2 md:mb-0 flex items-center gap-3">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 mb-1">${item.name}</h3>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-mono text-gray-600 bg-gray-100 px-2 py-1 rounded">${item.ticker}</span>
                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${typeColorClass}">${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 bg-gray-50 px-2 py-1 rounded">
                        <i class="fas fa-clock mr-1"></i>
                        Updated: ${formatDate(item.updated_at)}
                    </div>
                </div>

                <!-- ä»·æ ¼ä¿¡æ¯åŒºåŸŸ -->
                <div class="relative z-10 bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg p-4 mb-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-3">
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">Buy Price</div>
                            <div class="text-lg font-bold text-gray-700">$${item.buyin_price.toFixed(2)}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1 flex items-center justify-center">
                                <span class="w-2 h-2 bg-green-400 rounded-full mr-1 live-indicator"></span>
                                Current Price
                            </div>
                            <div class="current-price text-lg font-bold text-blue-600 transition-all duration-300">$${item.currentPrice.toFixed(2)}</div>
                            <div class="text-xs mt-1 ${item.dayChangePercent >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${item.dayChangePercent >= 0 ? '+' : ''}${item.dayChange.toFixed(2)} (${item.dayChangePercent >= 0 ? '+' : ''}${item.dayChangePercent.toFixed(2)}%)
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">Quantity</div>
                            <div class="text-lg font-bold text-gray-700">${item.quantity.toLocaleString()}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">Total Value</div>
                            <div class="text-lg font-bold text-gray-900">$${item.totalValue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                        </div>
                    </div>

                    <!-- å¸‚åœºæ•°æ®è¡Œ -->
                    ${item.open || item.high || item.low ? `
                    <div class="border-t border-gray-200 pt-3">
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-xs text-gray-500 mb-1">Open</div>
                                <div class="text-sm font-semibold text-gray-600">$${(item.open || 0).toFixed(2)}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">High</div>
                                <div class="text-sm font-semibold text-green-600">$${(item.high || 0).toFixed(2)}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 mb-1">Low</div>
                                <div class="text-sm font-semibold text-red-600">$${(item.low || 0).toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>

                <!-- ç›ˆäºä¿¡æ¯åŒºåŸŸ -->
                <div class="relative z-10 grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-white border border-gray-200 rounded-lg p-3 text-center">
                        <div class="text-xs text-gray-500 mb-1">Profit/Loss</div>
                        <div class="flex items-center justify-center">
                            <i class="fas fa-${item.profit >= 0 ? 'arrow-up' : 'arrow-down'} ${profitColor} mr-1 text-xs"></i>
                            <span class="${profitColor} font-bold text-lg">${profitSign}$${Math.abs(item.profit).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                        </div>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg p-3 text-center">
                        <div class="text-xs text-gray-500 mb-1">Profit Rate</div>
                        <div class="flex items-center justify-center">
                            <i class="fas fa-${item.profitRate >= 0 ? 'trending-up' : 'trending-down'} ${profitRateColor} mr-1 text-xs"></i>
                            <span class="${profitRateColor} font-bold text-lg">${profitSign}${profitRateDisplay}%</span>
                        </div>
                    </div>
                </div>

                <!-- ä»·æ ¼è¶‹åŠ¿å›¾åŒºåŸŸ -->
                <div class="relative z-10 bg-white border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-sm font-semibold text-gray-700">Price Trend (7 Days)</h4>
                        <div class="text-xs text-gray-500">
                            <i class="fas fa-chart-line mr-1"></i>
                            Live Data
                        </div>
                    </div>
                    <div class="relative" style="height: 120px;">
                        <canvas id="chart-${item.ticker}" class="w-full h-full"></canvas>
                    </div>
                    <div class="text-xs text-gray-400 text-center mt-2">
                        Hover to see details
                    </div>
                </div>

                <!-- æ•°æ®æºæŒ‡ç¤ºå™¨ -->
                <div class="relative z-10 flex justify-between items-center text-xs text-gray-400 mt-2">
                    <span>Data: ${item.dataSource || 'Unknown'}</span>
                    <span class="flex items-center">
                        <i class="fas fa-database mr-1"></i>
                        Real-time
                    </span>
                </div>
            </div>`;
                        container.innerHTML += html;
                    });

                    // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
                    setTimeout(() => {
                        initializeAllCharts(data);
                    }, 100);
                }

                // å›¾è¡¨ç›¸å…³å‡½æ•°
                const chartInstances = new Map(); // å­˜å‚¨å›¾è¡¨å®ä¾‹

                // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
                async function initializeAllCharts(holdings) {
                    for (const holding of holdings) {
                        await initializeChart(holding.ticker);
                    }
                }

                // åˆå§‹åŒ–å•ä¸ªå›¾è¡¨
                async function initializeChart(ticker) {
                    const canvas = document.getElementById(`chart-${ticker}`);
                    if (!canvas) {
                        console.warn(`Canvas not found for ${ticker}`);
                        return;
                    }

                    const ctx = canvas.getContext('2d');

                    // å¦‚æœå›¾è¡¨å·²å­˜åœ¨ï¼Œå…ˆé”€æ¯
                    if (chartInstances.has(ticker)) {
                        chartInstances.get(ticker).destroy();
                    }

                    try {
                        // è·å–å†å²ä»·æ ¼æ•°æ®
                        const priceData = await fetchHistoricalData(ticker);

                        // åˆ›å»ºå›¾è¡¨
                        const chart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: priceData.labels,
                                datasets: [{
                                    label: `${ticker} Price`,
                                    data: priceData.prices,
                                    borderColor: priceData.trend === 'up' ? '#10b981' : '#ef4444',
                                    backgroundColor: priceData.trend === 'up' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 0,
                                    pointHoverRadius: 4,
                                    pointHoverBackgroundColor: priceData.trend === 'up' ? '#10b981' : '#ef4444',
                                    pointHoverBorderColor: '#ffffff',
                                    pointHoverBorderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false,
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        titleColor: '#ffffff',
                                        bodyColor: '#ffffff',
                                        borderColor: priceData.trend === 'up' ? '#10b981' : '#ef4444',
                                        borderWidth: 1,
                                        cornerRadius: 6,
                                        displayColors: false,
                                        callbacks: {
                                            title: function(context) {
                                                return context[0].label;
                                            },
                                            label: function(context) {
                                                return `$${context.parsed.y.toFixed(2)}`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        display: false,
                                        grid: {
                                            display: false
                                        }
                                    },
                                    y: {
                                        display: false,
                                        grid: {
                                            display: false
                                        }
                                    }
                                },
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                elements: {
                                    point: {
                                        hoverRadius: 6
                                    }
                                }
                            }
                        });

                        chartInstances.set(ticker, chart);
                    } catch (error) {
                        console.error(`Failed to initialize chart for ${ticker}:`, error);
                        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                        canvas.style.display = 'none';
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'flex items-center justify-center h-full text-gray-400 text-sm';
                        errorDiv.innerHTML = '<i class="fas fa-chart-line mr-2"></i>Chart unavailable';
                        canvas.parentNode.appendChild(errorDiv);
                    }
                }

                // è·å–å†å²ä»·æ ¼æ•°æ®
                async function fetchHistoricalData(ticker) {
                    try {
                        // ç”Ÿæˆæ¨¡æ‹Ÿçš„7å¤©å†å²æ•°æ®
                        const days = 7;
                        const labels = [];
                        const prices = [];
                        const today = new Date();

                        // è·å–å½“å‰ä»·æ ¼ä½œä¸ºåŸºå‡†
                        let basePrice = 100; // é»˜è®¤åŸºå‡†ä»·æ ¼
                        try {
                            const currentPriceResponse = await fetch(`${API_CONFIG.TWELVE_DATA.baseUrl}/price?symbol=${ticker}&apikey=${API_CONFIG.TWELVE_DATA.apiKey}`);
                            if (currentPriceResponse.ok) {
                                const currentPriceData = await currentPriceResponse.json();
                                basePrice = parseFloat(currentPriceData.price) || 100;
                            }
                        } catch (error) {
                            console.warn(`Failed to get current price for ${ticker}, using default`);
                        }

                        // ç”Ÿæˆå†å²æ•°æ®ç‚¹
                        for (let i = days - 1; i >= 0; i--) {
                            const date = new Date(today);
                            date.setDate(date.getDate() - i);

                            // ç”Ÿæˆä»·æ ¼å˜åŒ–ï¼ˆæ¨¡æ‹ŸçœŸå®çš„ä»·æ ¼æ³¢åŠ¨ï¼‰
                            const volatility = 0.02; // 2% æ—¥æ³¢åŠ¨ç‡
                            const randomChange = (Math.random() - 0.5) * 2 * volatility;
                            const dayPrice = basePrice * (1 + randomChange * (i + 1) / days);

                            labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                            prices.push(parseFloat(dayPrice.toFixed(2)));
                        }

                        // ç¡®ä¿æœ€åä¸€ä¸ªä»·æ ¼æ˜¯å½“å‰ä»·æ ¼
                        prices[prices.length - 1] = basePrice;

                        // è®¡ç®—è¶‹åŠ¿
                        const firstPrice = prices[0];
                        const lastPrice = prices[prices.length - 1];
                        const trend = lastPrice >= firstPrice ? 'up' : 'down';

                        return {
                            labels,
                            prices,
                            trend
                        };
                    } catch (error) {
                        console.error(`Error fetching historical data for ${ticker}:`, error);

                        // è¿”å›é»˜è®¤æ•°æ®
                        const labels = ['6d ago', '5d ago', '4d ago', '3d ago', '2d ago', '1d ago', 'Today'];
                        const prices = [100, 102, 98, 105, 103, 107, 105];
                        return {
                            labels,
                            prices,
                            trend: 'up'
                        };
                    }
                }

                // æ›´æ–°å›¾è¡¨æ•°æ®
                function updateChartsWithNewPrices(holdings) {
                    holdings.forEach(holding => {
                        const chart = chartInstances.get(holding.ticker);
                        if (chart && holding.priceChanged) {
                            // æ›´æ–°å›¾è¡¨çš„æœ€åä¸€ä¸ªæ•°æ®ç‚¹
                            const dataset = chart.data.datasets[0];
                            if (dataset.data.length > 0) {
                                dataset.data[dataset.data.length - 1] = holding.currentPrice;

                                // æ›´æ–°é¢œè‰²åŸºäºä»·æ ¼å˜åŒ–
                                const trend = holding.dayChangePercent >= 0 ? 'up' : 'down';
                                dataset.borderColor = trend === 'up' ? '#10b981' : '#ef4444';
                                dataset.backgroundColor = trend === 'up' ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';

                                chart.update('none'); // æ— åŠ¨ç”»æ›´æ–°
                            }
                        }
                    });
                }

                // æ—§çš„DOMContentLoadedäº‹ä»¶ç›‘å¬å™¨å·²ç§»è‡³ä¸‹æ–¹ç»Ÿä¸€å¤„ç†


                function applyFilters() {
                    const type = typeFilter.value;
                    const sortBy = sortField.value;
                    const order = sortOrder.value;
                    let filtered = [...holdingsData];

                    // ç­›é€‰
                    if (type !== "all") {
                        filtered = filtered.filter(item => item.type === type);
                    }

                    // æ’åº
                    filtered.sort((a, b) => {
                        let valA, valB;

                        // æ ¹æ® sortBy å­—æ®µè·å–å€¼
                        if (sortBy === "profitRate") {
                            // ä½¿ç”¨å·²è®¡ç®—å¥½çš„ç›ˆäºç‡
                            valA = a.profitRate;
                            valB = b.profitRate;
                        } else if (sortBy === "updated_at") {
                            // å°†æ—¶é—´æˆ³å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—è¿›è¡Œæ¯”è¾ƒ
                            valA = new Date(a[sortBy]).getTime();
                            valB = new Date(b[sortBy]).getTime();
                        } else {
                            valA = a[sortBy];
                            valB = b[sortBy];
                        }

                        // å¤„ç†éæ•°å­—å€¼çš„æ¯”è¾ƒï¼ˆå¦‚æœ sortBy å­—æ®µæ˜¯å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ nameï¼‰
                        if (typeof valA === 'string' && typeof valB === 'string') {
                            return order === "asc" ? valA.localeCompare(valB) : valB.localeCompare(valA);
                        }

                        // æ•°å­—æ¯”è¾ƒ
                        return order === "asc" ? valA - valB : valB - valA;
                    });

                    renderHoldings(filtered);
                }

                // ä¾§è¾¹æ æ”¶èµ·/å±•å¼€åŠŸèƒ½
                let sidebarCollapsed = false;
                function toggleSidebar() {
                    sidebarCollapsed = !sidebarCollapsed;
                    const sidebar = document.getElementById('sidebar');
                    const main = document.getElementById('mainContent');
                    const texts = sidebar.querySelectorAll('.sidebar-text');
                    if (sidebarCollapsed) {
                        sidebar.classList.remove('w-48');
                        sidebar.classList.add('w-16');
                        main.classList.remove('md:ml-48');
                        main.classList.add('md:ml-16');
                        texts.forEach(t => t.classList.add('hidden'));
                        document.getElementById('sidebarToggleIcon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />';
                    } else {
                        sidebar.classList.remove('w-16');
                        sidebar.classList.add('w-48');
                        main.classList.remove('md:ml-16');
                        main.classList.add('md:ml-48');
                        texts.forEach(t => t.classList.remove('hidden'));
                        document.getElementById('sidebarToggleIcon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 12H5" />';
                    }
                }

                // å®æ—¶æ›´æ–°ä»·æ ¼çš„å®šæ—¶å™¨
                let priceUpdateInterval;

                document.addEventListener("DOMContentLoaded", function () {
                    // å…ˆæ£€æŸ¥ç™»å½•çŠ¶æ€
                    checkLoginStatus();

                    // ä½¿ç”¨åŠ¨æ€ç”¨æˆ·ID
                    const userId = getCurrentUserId();
                    fetchHoldings(userId);

                    // æ·»åŠ è¿‡æ»¤å™¨äº‹ä»¶ç›‘å¬å™¨
                    typeFilter.addEventListener('change', applyFilters);
                    sortField.addEventListener('change', applyFilters);
                    sortOrder.addEventListener('change', applyFilters);

                    // å¯åŠ¨å®æ—¶ä»·æ ¼æ›´æ–°ï¼ˆæ¯15ç§’æ›´æ–°ä¸€æ¬¡ï¼‰
                    startPriceUpdates(userId);
                });

                // å¯åŠ¨å®æ—¶ä»·æ ¼æ›´æ–°
                function startPriceUpdates(userId) {
                    // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
                    if (priceUpdateInterval) {
                        clearInterval(priceUpdateInterval);
                    }

                    // æ¯15ç§’æ›´æ–°ä¸€æ¬¡ä»·æ ¼
                    priceUpdateInterval = setInterval(() => {
                        updatePricesOnly();
                    }, 15000);
                }

                // åªæ›´æ–°ä»·æ ¼ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨
                async function updatePricesOnly() {
                    if (holdingsData.length === 0) return;

                    console.log('ğŸ”„ Updating real-time prices...');

                    try {
                        let hasChanges = false;

                        // æ›´æ–°æ¯ä¸ªæŒä»“çš„ä»·æ ¼
                        const updatedData = await Promise.all(holdingsData.map(async (item) => {
                            try {
                                // ä½¿ç”¨å¤–éƒ¨APIè·å–æœ€æ–°ä»·æ ¼
                                const priceData = await getExternalStockPrice(item.ticker);

                                let currentPrice = item.currentPrice;
                                let priceChanged = false;
                                let dayChange = item.dayChange || 0;
                                let dayChangePercent = item.dayChangePercent || 0;

                                if (priceData && priceData.price > 0) {
                                    const newPrice = priceData.price;
                                    if (Math.abs(newPrice - item.currentPrice) > 0.01) {
                                        currentPrice = newPrice;
                                        dayChange = priceData.change || 0;
                                        dayChangePercent = priceData.changePercent || 0;
                                        priceChanged = true;
                                        hasChanges = true;
                                    }
                                }

                                // é‡æ–°è®¡ç®—ç›¸å…³æ•°å€¼
                                const totalValue = item.quantity * currentPrice;
                                const totalCost = item.quantity * item.buyin_price;
                                const profit = totalValue - totalCost;
                                const profitRate = totalCost > 0 ? ((profit / totalCost) * 100) : 0;

                                return {
                                    ...item,
                                    currentPrice,
                                    totalValue,
                                    profit,
                                    profitRate,
                                    dayChange,
                                    dayChangePercent,
                                    priceChanged,
                                    high: priceData?.high || item.high,
                                    low: priceData?.low || item.low,
                                    open: priceData?.open || item.open,
                                    dataSource: priceData?.source || item.dataSource
                                };
                            } catch (error) {
                                console.warn(`Failed to update external price for ${item.ticker}:`, error);
                                return { ...item, priceChanged: false }; // ä¿æŒåŸæ•°æ®
                            }
                        }));

                        // æ›´æ–°å…¨å±€æ•°æ®
                        holdingsData = updatedData;

                        // å¦‚æœæœ‰ä»·æ ¼å˜åŒ–ï¼Œæ·»åŠ åŠ¨ç”»æ•ˆæœ
                        if (hasChanges) {
                            // æ›´æ–°æ¦‚è§ˆæ•°æ®
                            updatePortfolioSummary();

                            // é‡æ–°åº”ç”¨è¿‡æ»¤å™¨å’Œæ’åº
                            applyFilters();

                            // æ›´æ–°å›¾è¡¨æ•°æ®
                            updateChartsWithNewPrices(updatedData);

                            // æ·»åŠ ä»·æ ¼å˜åŒ–åŠ¨ç”»
                            setTimeout(() => {
                                holdingsData.forEach(item => {
                                    if (item.priceChanged) {
                                        const priceElement = document.querySelector(`[data-ticker="${item.ticker}"] .current-price`);
                                        if (priceElement) {
                                            priceElement.classList.add('price-updated');
                                            setTimeout(() => {
                                                priceElement.classList.remove('price-updated');
                                            }, 1000);
                                        }
                                    }
                                });
                            }, 100);

                            console.log('âœ… Prices updated with changes detected');
                        } else {
                            console.log('ğŸ“Š Prices checked - no changes detected');
                        }

                        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
                        updateLastUpdateTime();
                    } catch (error) {
                        console.error('âŒ Failed to update prices:', error);
                    }
                }

                // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
                function updateLastUpdateTime() {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString();
                    const lastUpdateElement = document.getElementById('lastUpdateTime');
                    if (lastUpdateElement) {
                        lastUpdateElement.textContent = `Last updated: ${timeString}`;
                    }
                }

                // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨å’Œå›¾è¡¨
                window.addEventListener('beforeunload', function() {
                    if (priceUpdateInterval) {
                        clearInterval(priceUpdateInterval);
                    }

                    // æ¸…ç†æ‰€æœ‰å›¾è¡¨å®ä¾‹
                    chartInstances.forEach((chart, ticker) => {
                        chart.destroy();
                    });
                    chartInstances.clear();
                });
            </script>

</body>

</html>